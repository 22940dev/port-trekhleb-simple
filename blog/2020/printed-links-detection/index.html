<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.d23e9cf4c6075e08caab.css" id="gatsby-global-css">@import url(https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap);.post--2021--binary-floating-point--bit-button:hover{box-shadow:0 0 5px 1px rgba(0,0,0,.2);transition:box-shadow .2s ease-in-out}input:checked~.toggle__dot{transform:translateX(100%)}input:checked~.toggle__line{background-color:#48bb78}.post--2021--water-line--gyro-cube .gyro-cube-container{height:400px;display:flex;justify-content:center;align-items:center;perspective:800px;perspective-origin:50%}.post--2021--water-line--gyro-cube .gyro-cube{position:relative;width:200px;height:200px;transform-style:preserve-3d}.post--2021--water-line--gyro-cube .gyro-cube-side{position:absolute;width:100%;height:100%;opacity:.8;border:2px solid #fff;display:flex;justify-content:center;align-items:center;color:#fff;font-weight:700;font-size:100px}.post--2021--water-line--gyro-cube .gyro-cube-front{background-color:#d50000;transform:translateZ(100px)}.post--2021--water-line--gyro-cube .gyro-cube-back{background-color:#a0f;transform:translateZ(-100px)}.post--2021--water-line--gyro-cube .gyro-cube-left{background-color:#304ffe;transform:translateX(100px) rotateY(90deg)}.post--2021--water-line--gyro-cube .gyro-cube-right{background-color:#0091ea;transform:translateX(-100px) rotateY(90deg)}.post--2021--water-line--gyro-cube .gyro-cube-top{background-color:#00bfa5;transform:translateY(-100px) rotateX(90deg)}.post--2021--water-line--gyro-cube .gyro-cube-bottom{background-color:#64dd17;transform:translateY(100px) rotateX(90deg)}.custom-fade-in-opacity{opacity:1;-webkit-animation-name:customFadeInOpacity;animation-name:customFadeInOpacity;-webkit-animation-iteration-count:1;animation-iteration-count:1;-webkit-animation-timing-function:ease-out;animation-timing-function:ease-out;-webkit-animation-duration:.8s;animation-duration:.8s}@-webkit-keyframes customFadeInOpacity{0%{opacity:0}to{opacity:1}}@keyframes customFadeInOpacity{0%{opacity:0}to{opacity:1}}.prose blockquote p:first-of-type:before,.prose blockquote p:last-of-type:after,.prose code:after,.prose code:before{content:""!important}.prose blockquote{font-weight:400!important}.prose li code.language-text,.prose p code.language-text{padding:2px 5px 1px;font-weight:400}.prose p>img{margin:auto}.prose h1>a.gatsby-remark-autolink-header-anchor,.prose h2>a.gatsby-remark-autolink-header-anchor,.prose h3>a.gatsby-remark-autolink-header-anchor,.prose h4>a.gatsby-remark-autolink-header-anchor,.prose h5>a.gatsby-remark-autolink-header-anchor{visibility:hidden;display:inline-block;margin-left:10px}.prose h1:hover>a.gatsby-remark-autolink-header-anchor,.prose h2:hover>a.gatsby-remark-autolink-header-anchor,.prose h3:hover>a.gatsby-remark-autolink-header-anchor,.prose h4:hover>a.gatsby-remark-autolink-header-anchor,.prose h5:hover>a.gatsby-remark-autolink-header-anchor{visibility:visible}

/* ! tailwindcss v2.1.2 | MIT License | https://tailwindcss.com */

/*! modern-normalize v1.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize */:root{-moz-tab-size:4;-o-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji}hr{height:0;color:inherit}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}legend{padding:0}progress{vertical-align:baseline}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:Roboto,ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{font-family:inherit;line-height:inherit}*,:after,:before{box-sizing:border-box;border:0 solid #e5e7eb}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::-moz-placeholder,textarea::-moz-placeholder{opacity:1;color:#9ca3af}input:-ms-input-placeholder,textarea:-ms-input-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}.prose{color:#374151;max-width:65ch}.prose [class~=lead]{color:#4b5563;font-size:1.25em;line-height:1.6;margin-top:1.2em;margin-bottom:1.2em}.prose a{color:#dc2626;text-decoration:underline;font-weight:500}.prose a:hover{color:#ef4444}.prose strong{color:#111827;font-weight:600}.prose ol[type=a]{--list-counter-style:lower-alpha}.prose ol[type=I]{--list-counter-style:upper-roman}.prose ol[type=i]{--list-counter-style:lower-roman}.prose ol[type="1"]{--list-counter-style:decimal}.prose ol>li{position:relative;padding-left:1.75em}.prose ol>li:before{content:counter(list-item,var(--list-counter-style,decimal)) ".";position:absolute;font-weight:400;color:#6b7280;left:0}.prose ul>li{position:relative;padding-left:1.75em}.prose ul>li:before{content:"";position:absolute;background-color:#d1d5db;border-radius:50%;width:.375em;height:.375em;top:.6875em;left:.25em}.prose hr{border-color:#e5e7eb;border-top-width:1px;margin-top:3em;margin-bottom:3em}.prose blockquote{font-weight:500;font-style:italic;color:#111827;border-left-width:.25rem;border-left-color:#e5e7eb;quotes:"\201C""\201D""\2018""\2019";margin-top:1.6em;margin-bottom:1.6em;padding-left:1em}.prose blockquote p:first-of-type:before{content:open-quote}.prose blockquote p:last-of-type:after{content:close-quote}.prose h1{color:#111827;font-weight:800;font-size:2.25em;margin-top:0;margin-bottom:.8888889em;line-height:1.1111111}.prose h2{color:#111827;font-weight:700;font-size:1.5em;margin-top:2em;margin-bottom:1em;line-height:1.3333333}.prose h3{font-size:1.25em;margin-top:1.6em;margin-bottom:.6em;line-height:1.6}.prose h3,.prose h4{color:#111827;font-weight:600}.prose h4{margin-top:1.5em;margin-bottom:.5em;line-height:1.5}.prose figure figcaption{color:#6b7280;font-size:.875em;line-height:1.4285714;margin-top:.8571429em}.prose code{color:#111827;font-weight:600;font-size:.875em}.prose code:after,.prose code:before{content:"`"}.prose a code{color:#111827}.prose pre{color:#e5e7eb;background-color:#1f2937;overflow-x:auto;font-size:.875em;line-height:1.7142857;margin-top:1.7142857em;margin-bottom:1.7142857em;border-radius:.375rem;padding:.8571429em 1.1428571em}.prose pre code{background-color:transparent;border-width:0;border-radius:0;padding:0;font-weight:400;color:inherit;font-size:inherit;font-family:inherit;line-height:inherit}.prose pre code:after,.prose pre code:before{content:none}.prose table{width:100%;table-layout:auto;text-align:left;margin-top:2em;margin-bottom:2em;font-size:.875em;line-height:1.7142857}.prose thead{color:#111827;font-weight:600;border-bottom-width:1px;border-bottom-color:#d1d5db}.prose thead th{vertical-align:bottom;padding-right:.5714286em;padding-bottom:.5714286em;padding-left:.5714286em}.prose tbody tr{border-bottom-width:1px;border-bottom-color:#e5e7eb}.prose tbody tr:last-child{border-bottom-width:0}.prose tbody td{vertical-align:top;padding:.5714286em}.prose{font-size:1rem;line-height:1.75}.prose p{margin-top:1.25em;margin-bottom:1.25em}.prose figure,.prose img,.prose video{margin-top:2em;margin-bottom:2em}.prose figure>*{margin-top:0;margin-bottom:0}.prose h2 code{font-size:.875em}.prose h3 code{font-size:.9em}.prose ol,.prose ul{margin-top:1.25em;margin-bottom:1.25em}.prose li{margin-top:.5em;margin-bottom:.5em}.prose>ul>li p{margin-top:.75em;margin-bottom:.75em}.prose>ul>li>:first-child{margin-top:1.25em}.prose>ul>li>:last-child{margin-bottom:1.25em}.prose>ol>li>:first-child{margin-top:1.25em}.prose>ol>li>:last-child{margin-bottom:1.25em}.prose ol ol,.prose ol ul,.prose ul ol,.prose ul ul{margin-top:.75em;margin-bottom:.75em}.prose h2+*,.prose h3+*,.prose h4+*,.prose hr+*{margin-top:0}.prose thead th:first-child{padding-left:0}.prose thead th:last-child{padding-right:0}.prose tbody td:first-child{padding-left:0}.prose tbody td:last-child{padding-right:0}.prose>:first-child{margin-top:0}.prose>:last-child{margin-bottom:0}.prose-sm{font-size:.875rem;line-height:1.7142857}.prose-sm p{margin-top:1.1428571em;margin-bottom:1.1428571em}.prose-sm [class~=lead]{font-size:1.2857143em;line-height:1.5555556;margin-top:.8888889em;margin-bottom:.8888889em}.prose-sm blockquote{margin-top:1.3333333em;margin-bottom:1.3333333em;padding-left:1.1111111em}.prose-sm h1{font-size:2.1428571em;margin-top:0;margin-bottom:.8em;line-height:1.2}.prose-sm h2{font-size:1.4285714em;margin-top:1.6em;margin-bottom:.8em;line-height:1.4}.prose-sm h3{font-size:1.2857143em;margin-top:1.5555556em;margin-bottom:.4444444em;line-height:1.5555556}.prose-sm h4{margin-top:1.4285714em;margin-bottom:.5714286em;line-height:1.4285714}.prose-sm figure,.prose-sm img,.prose-sm video{margin-top:1.7142857em;margin-bottom:1.7142857em}.prose-sm figure>*{margin-top:0;margin-bottom:0}.prose-sm figure figcaption{font-size:.8571429em;line-height:1.3333333;margin-top:.6666667em}.prose-sm code{font-size:.8571429em}.prose-sm h2 code{font-size:.9em}.prose-sm h3 code{font-size:.8888889em}.prose-sm pre{font-size:.8571429em;line-height:1.6666667;margin-top:1.6666667em;margin-bottom:1.6666667em;border-radius:.25rem;padding:.6666667em 1em}.prose-sm ol,.prose-sm ul{margin-top:1.1428571em;margin-bottom:1.1428571em}.prose-sm li{margin-top:.2857143em;margin-bottom:.2857143em}.prose-sm ol>li{padding-left:1.5714286em}.prose-sm ol>li:before{left:0}.prose-sm ul>li{padding-left:1.5714286em}.prose-sm ul>li:before{height:.3571429em;width:.3571429em;top:.67857em;left:.2142857em}.prose-sm>ul>li p{margin-top:.5714286em;margin-bottom:.5714286em}.prose-sm>ul>li>:first-child{margin-top:1.1428571em}.prose-sm>ul>li>:last-child{margin-bottom:1.1428571em}.prose-sm>ol>li>:first-child{margin-top:1.1428571em}.prose-sm>ol>li>:last-child{margin-bottom:1.1428571em}.prose-sm ol ol,.prose-sm ol ul,.prose-sm ul ol,.prose-sm ul ul{margin-top:.5714286em;margin-bottom:.5714286em}.prose-sm hr{margin-top:2.8571429em;margin-bottom:2.8571429em}.prose-sm h2+*,.prose-sm h3+*,.prose-sm h4+*,.prose-sm hr+*{margin-top:0}.prose-sm table{font-size:.8571429em;line-height:1.5}.prose-sm thead th{padding-right:1em;padding-bottom:.6666667em;padding-left:1em}.prose-sm thead th:first-child{padding-left:0}.prose-sm thead th:last-child{padding-right:0}.prose-sm tbody td{padding:.6666667em 1em}.prose-sm tbody td:first-child{padding-left:0}.prose-sm tbody td:last-child{padding-right:0}.prose-sm>:first-child{margin-top:0}.prose-sm>:last-child{margin-bottom:0}.prose-red a,.prose-red a code{color:#dc2626}.appearance-none{-webkit-appearance:none;-moz-appearance:none;appearance:none}.bg-black{--tw-bg-opacity:1;background-color:rgba(0,0,0,var(--tw-bg-opacity))}.bg-white{--tw-bg-opacity:1;background-color:rgba(255,255,255,var(--tw-bg-opacity))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgba(243,244,246,var(--tw-bg-opacity))}.bg-gray-200{--tw-bg-opacity:1;background-color:rgba(229,231,235,var(--tw-bg-opacity))}.bg-gray-400{--tw-bg-opacity:1;background-color:rgba(156,163,175,var(--tw-bg-opacity))}.bg-red-100{--tw-bg-opacity:1;background-color:rgba(254,226,226,var(--tw-bg-opacity))}.bg-blue-100{--tw-bg-opacity:1;background-color:rgba(219,234,254,var(--tw-bg-opacity))}.hover\:bg-black:hover{--tw-bg-opacity:1;background-color:rgba(0,0,0,var(--tw-bg-opacity))}.hover\:bg-white:hover{--tw-bg-opacity:1;background-color:rgba(255,255,255,var(--tw-bg-opacity))}.hover\:bg-gray-800:hover{--tw-bg-opacity:1;background-color:rgba(31,41,55,var(--tw-bg-opacity))}.hover\:bg-red-500:hover{--tw-bg-opacity:1;background-color:rgba(239,68,68,var(--tw-bg-opacity))}.bg-cover{background-size:cover}.border-black{--tw-border-opacity:1;border-color:rgba(0,0,0,var(--tw-border-opacity))}.border-white{--tw-border-opacity:1;border-color:rgba(255,255,255,var(--tw-border-opacity))}.border-gray-300{--tw-border-opacity:1;border-color:rgba(209,213,219,var(--tw-border-opacity))}.border-gray-400{--tw-border-opacity:1;border-color:rgba(156,163,175,var(--tw-border-opacity))}.border-red-500{--tw-border-opacity:1;border-color:rgba(239,68,68,var(--tw-border-opacity))}.hover\:border-white:hover{--tw-border-opacity:1;border-color:rgba(255,255,255,var(--tw-border-opacity))}.hover\:border-gray-400:hover{--tw-border-opacity:1;border-color:rgba(156,163,175,var(--tw-border-opacity))}.rounded-sm{border-radius:.125rem}.rounded{border-radius:.25rem}.rounded-md{border-radius:.375rem}.rounded-full{border-radius:9999px}.border-solid{border-style:solid}.border-dashed{border-style:dashed}.border{border-width:1px}.cursor-pointer{cursor:pointer}.cursor-not-allowed{cursor:not-allowed}.block{display:block}.inline-block{display:inline-block}.flex{display:flex}.table{display:table}.grid{display:grid}.hidden{display:none}.flex-row{flex-direction:row}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.items-stretch{align-items:stretch}.self-start{align-self:flex-start}.self-stretch{align-self:stretch}.justify-start{justify-content:flex-start}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.justify-self-end{justify-self:end}.flex-1{flex:1 1 0%}.font-light{font-weight:300}.font-normal{font-weight:400}.font-medium{font-weight:500}.font-semibold{font-weight:600}.font-bold{font-weight:700}.font-extrabold{font-weight:800}.h-0{height:0}.h-4{height:1rem}.h-5{height:1.25rem}.h-6{height:1.5rem}.h-48{height:12rem}.h-64{height:16rem}.h-96{height:24rem}.h-0\.5{height:.125rem}.h-full{height:100%}.text-xs{font-size:.75rem;line-height:1rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.m-auto{margin:auto}.mr-0{margin-right:0}.mb-0{margin-bottom:0}.mr-1{margin-right:.25rem}.mb-1{margin-bottom:.25rem}.ml-1{margin-left:.25rem}.mt-2{margin-top:.5rem}.mr-2{margin-right:.5rem}.mb-2{margin-bottom:.5rem}.ml-2{margin-left:.5rem}.mt-3{margin-top:.75rem}.mr-3{margin-right:.75rem}.mb-3{margin-bottom:.75rem}.ml-3{margin-left:.75rem}.mr-4{margin-right:1rem}.mb-4{margin-bottom:1rem}.ml-4{margin-left:1rem}.mr-5{margin-right:1.25rem}.ml-5{margin-left:1.25rem}.mt-6{margin-top:1.5rem}.mr-6{margin-right:1.5rem}.mb-6{margin-bottom:1.5rem}.mb-12{margin-bottom:3rem}.mt-16{margin-top:4rem}.max-w-md{max-width:28rem}.max-w-screen-xl{max-width:1280px}.overflow-hidden{overflow:hidden}.overflow-scroll{overflow:scroll}.p-6{padding:1.5rem}.p-8{padding:2rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.px-1{padding-left:.25rem;padding-right:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.px-2{padding-left:.5rem;padding-right:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-12{padding-top:3rem;padding-bottom:3rem}.pb-6{padding-bottom:1.5rem}.static{position:static}.absolute{position:absolute}.relative{position:relative}.inset-y-0{top:0;bottom:0}.left-0{left:0}.resize{resize:both}*{--tw-shadow:0 0 transparent}.shadow-sm{--tw-shadow:0 1px 2px 0 rgba(0,0,0,0.05)}.shadow,.shadow-sm{box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow)}.shadow{--tw-shadow:0 1px 3px 0 rgba(0,0,0,0.1),0 1px 2px 0 rgba(0,0,0,0.06)}.shadow-md{--tw-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06)}.shadow-inner,.shadow-md{box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow)}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 rgba(0,0,0,0.06)}.shadow-card{--tw-shadow:0 2px 1px -1px rgba(0,0,0,0.2),0 1px 1px 0 rgba(0,0,0,0.14),0 1px 3px 0 rgba(0,0,0,0.12);box-shadow:var(--tw-ring-offset-shadow,0 0 transparent),var(--tw-ring-shadow,0 0 transparent),var(--tw-shadow)}*{--tw-ring-inset:var(--tw-empty,/*!*/ /*!*/);--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgba(59,130,246,0.5);--tw-ring-offset-shadow:0 0 transparent;--tw-ring-shadow:0 0 transparent}.text-center{text-align:center}.text-black{--tw-text-opacity:1;color:rgba(0,0,0,var(--tw-text-opacity))}.text-white{--tw-text-opacity:1;color:rgba(255,255,255,var(--tw-text-opacity))}.text-gray-400{--tw-text-opacity:1;color:rgba(156,163,175,var(--tw-text-opacity))}.text-gray-500{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}.text-gray-700{--tw-text-opacity:1;color:rgba(55,65,81,var(--tw-text-opacity))}.text-red-500{--tw-text-opacity:1;color:rgba(239,68,68,var(--tw-text-opacity))}.text-red-600{--tw-text-opacity:1;color:rgba(220,38,38,var(--tw-text-opacity))}.text-blue-600{--tw-text-opacity:1;color:rgba(37,99,235,var(--tw-text-opacity))}.hover\:text-black:hover{--tw-text-opacity:1;color:rgba(0,0,0,var(--tw-text-opacity))}.hover\:text-white:hover{--tw-text-opacity:1;color:rgba(255,255,255,var(--tw-text-opacity))}.hover\:text-gray-500:hover{--tw-text-opacity:1;color:rgba(107,114,128,var(--tw-text-opacity))}.hover\:text-red-600:hover{--tw-text-opacity:1;color:rgba(220,38,38,var(--tw-text-opacity))}.uppercase{text-transform:uppercase}.underline{text-decoration:underline}.tracking-wider{letter-spacing:.05em}.tracking-widest{letter-spacing:.1em}.whitespace-nowrap{white-space:nowrap}.w-1{width:.25rem}.w-2{width:.5rem}.w-4{width:1rem}.w-5{width:1.25rem}.w-6{width:1.5rem}.w-10{width:2.5rem}.w-14{width:3.5rem}.w-16{width:4rem}.w-36{width:9rem}.w-64{width:16rem}.w-full{width:100%}.gap-12{gap:3rem}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.transform{--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;transform:translateX(var(--tw-translate-x)) translateY(var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.hover\:scale-105:hover{--tw-scale-x:1.05;--tw-scale-y:1.05}.hover\:-translate-y-1:hover{--tw-translate-y:-0.25rem}.transition{transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,-webkit-backdrop-filter;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter,-webkit-backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.ease-in-out{transition-timing-function:cubic-bezier(.4,0,.2,1)}.duration-200{transition-duration:.2s}.duration-500{transition-duration:.5s}@-webkit-keyframes spin{to{transform:rotate(1turn)}}@keyframes spin{to{transform:rotate(1turn)}}@-webkit-keyframes ping{75%,to{transform:scale(2);opacity:0}}@keyframes ping{75%,to{transform:scale(2);opacity:0}}@-webkit-keyframes pulse{50%{opacity:.5}}@keyframes pulse{50%{opacity:.5}}@-webkit-keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}@keyframes bounce{0%,to{transform:translateY(-25%);-webkit-animation-timing-function:cubic-bezier(.8,0,1,1);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;-webkit-animation-timing-function:cubic-bezier(0,0,.2,1);animation-timing-function:cubic-bezier(0,0,.2,1)}}.filter{--tw-blur:var(--tw-empty,/*!*/ /*!*/);--tw-brightness:var(--tw-empty,/*!*/ /*!*/);--tw-contrast:var(--tw-empty,/*!*/ /*!*/);--tw-grayscale:var(--tw-empty,/*!*/ /*!*/);--tw-hue-rotate:var(--tw-empty,/*!*/ /*!*/);--tw-invert:var(--tw-empty,/*!*/ /*!*/);--tw-saturate:var(--tw-empty,/*!*/ /*!*/);--tw-sepia:var(--tw-empty,/*!*/ /*!*/);--tw-drop-shadow:var(--tw-empty,/*!*/ /*!*/);filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.grayscale{--tw-grayscale:grayscale(100%)}@media (min-width:640px){.sm\:prose{color:#374151;max-width:65ch}.sm\:prose [class~=lead]{color:#4b5563;font-size:1.25em;line-height:1.6;margin-top:1.2em;margin-bottom:1.2em}.sm\:prose a{color:#dc2626;text-decoration:underline;font-weight:500}.sm\:prose a:hover{color:#ef4444}.sm\:prose strong{color:#111827;font-weight:600}.sm\:prose ol[type=a]{--list-counter-style:lower-alpha}.sm\:prose ol[type=I]{--list-counter-style:upper-roman}.sm\:prose ol[type=i]{--list-counter-style:lower-roman}.sm\:prose ol[type="1"]{--list-counter-style:decimal}.sm\:prose ol>li{position:relative;padding-left:1.75em}.sm\:prose ol>li:before{content:counter(list-item,var(--list-counter-style,decimal)) ".";position:absolute;font-weight:400;color:#6b7280;left:0}.sm\:prose ul>li{position:relative;padding-left:1.75em}.sm\:prose ul>li:before{content:"";position:absolute;background-color:#d1d5db;border-radius:50%;width:.375em;height:.375em;top:.6875em;left:.25em}.sm\:prose hr{border-color:#e5e7eb;border-top-width:1px;margin-top:3em;margin-bottom:3em}.sm\:prose blockquote{font-weight:500;font-style:italic;color:#111827;border-left-width:.25rem;border-left-color:#e5e7eb;quotes:"\201C""\201D""\2018""\2019";margin-top:1.6em;margin-bottom:1.6em;padding-left:1em}.sm\:prose blockquote p:first-of-type:before{content:open-quote}.sm\:prose blockquote p:last-of-type:after{content:close-quote}.sm\:prose h1{color:#111827;font-weight:800;font-size:2.25em;margin-top:0;margin-bottom:.8888889em;line-height:1.1111111}.sm\:prose h2{color:#111827;font-weight:700;font-size:1.5em;margin-top:2em;margin-bottom:1em;line-height:1.3333333}.sm\:prose h3{font-size:1.25em;margin-top:1.6em;margin-bottom:.6em;line-height:1.6}.sm\:prose h3,.sm\:prose h4{color:#111827;font-weight:600}.sm\:prose h4{margin-top:1.5em;margin-bottom:.5em;line-height:1.5}.sm\:prose figure figcaption{color:#6b7280;font-size:.875em;line-height:1.4285714;margin-top:.8571429em}.sm\:prose code{color:#111827;font-weight:600;font-size:.875em}.sm\:prose code:after,.sm\:prose code:before{content:"`"}.sm\:prose a code{color:#111827}.sm\:prose pre{color:#e5e7eb;background-color:#1f2937;overflow-x:auto;font-size:.875em;line-height:1.7142857;margin-top:1.7142857em;margin-bottom:1.7142857em;border-radius:.375rem;padding:.8571429em 1.1428571em}.sm\:prose pre code{background-color:transparent;border-width:0;border-radius:0;padding:0;font-weight:400;color:inherit;font-size:inherit;font-family:inherit;line-height:inherit}.sm\:prose pre code:after,.sm\:prose pre code:before{content:none}.sm\:prose table{width:100%;table-layout:auto;text-align:left;margin-top:2em;margin-bottom:2em;font-size:.875em;line-height:1.7142857}.sm\:prose thead{color:#111827;font-weight:600;border-bottom-width:1px;border-bottom-color:#d1d5db}.sm\:prose thead th{vertical-align:bottom;padding-right:.5714286em;padding-bottom:.5714286em;padding-left:.5714286em}.sm\:prose tbody tr{border-bottom-width:1px;border-bottom-color:#e5e7eb}.sm\:prose tbody tr:last-child{border-bottom-width:0}.sm\:prose tbody td{vertical-align:top;padding:.5714286em}.sm\:prose{font-size:1rem;line-height:1.75}.sm\:prose p{margin-top:1.25em;margin-bottom:1.25em}.sm\:prose figure,.sm\:prose img,.sm\:prose video{margin-top:2em;margin-bottom:2em}.sm\:prose figure>*{margin-top:0;margin-bottom:0}.sm\:prose h2 code{font-size:.875em}.sm\:prose h3 code{font-size:.9em}.sm\:prose ol,.sm\:prose ul{margin-top:1.25em;margin-bottom:1.25em}.sm\:prose li{margin-top:.5em;margin-bottom:.5em}.sm\:prose>ul>li p{margin-top:.75em;margin-bottom:.75em}.sm\:prose>ul>li>:first-child{margin-top:1.25em}.sm\:prose>ul>li>:last-child{margin-bottom:1.25em}.sm\:prose>ol>li>:first-child{margin-top:1.25em}.sm\:prose>ol>li>:last-child{margin-bottom:1.25em}.sm\:prose ol ol,.sm\:prose ol ul,.sm\:prose ul ol,.sm\:prose ul ul{margin-top:.75em;margin-bottom:.75em}.sm\:prose h2+*,.sm\:prose h3+*,.sm\:prose h4+*,.sm\:prose hr+*{margin-top:0}.sm\:prose thead th:first-child{padding-left:0}.sm\:prose thead th:last-child{padding-right:0}.sm\:prose tbody td:first-child{padding-left:0}.sm\:prose tbody td:last-child{padding-right:0}.sm\:prose>:first-child{margin-top:0}.sm\:prose>:last-child{margin-bottom:0}.sm\:flex{display:flex}.sm\:flex-row{flex-direction:row}.sm\:items-start{align-items:flex-start}.sm\:items-center{align-items:center}.sm\:flex-1{flex:1 1 0%}.sm\:h-auto{height:auto}.sm\:mb-0{margin-bottom:0}.sm\:mr-6{margin-right:1.5rem}.sm\:px-12{padding-left:3rem;padding-right:3rem}.sm\:text-left{text-align:left}.sm\:w-2\/5{width:40%}.sm\:w-3\/5{width:60%}.sm\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}}@media (min-width:1024px){.lg\:w-1\/4{width:25%}.lg\:w-3\/4{width:75%}.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 3.4.0"/><title data-react-helmet="true">Making the Printed Links Clickable Using TensorFlow 2 Object Detection API | Trekhleb</title><meta data-react-helmet="true" name="description" content="In this article we will start solving the issue of making the printed links (i.e. in a book or in a magazine) clickable via your smartphone camera"/><meta data-react-helmet="true" name="image" content="https://trekhleb.dev/static/55a94699f1c16ff59258cbb490d497eb/eb0de/01-cover.png"/><meta data-react-helmet="true" property="og:title" content="Making the Printed Links Clickable Using TensorFlow 2 Object Detection API | Trekhleb"/><meta data-react-helmet="true" property="og:description" content="In this article we will start solving the issue of making the printed links (i.e. in a book or in a magazine) clickable via your smartphone camera"/><meta data-react-helmet="true" property="og:url" content="https://trekhleb.dev/blog/2020/printed-links-detection/"/><meta data-react-helmet="true" property="og:image" content="https://trekhleb.dev/static/55a94699f1c16ff59258cbb490d497eb/eb0de/01-cover.png"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"/><meta data-react-helmet="true" name="twitter:creator" content="@Trekhleb"/><meta data-react-helmet="true" name="twitter:title" content="Making the Printed Links Clickable Using TensorFlow 2 Object Detection API | Trekhleb"/><meta data-react-helmet="true" name="twitter:description" content="In this article we will start solving the issue of making the printed links (i.e. in a book or in a magazine) clickable via your smartphone camera"/><meta data-react-helmet="true" name="twitter:image" content="https://trekhleb.dev/static/55a94699f1c16ff59258cbb490d497eb/eb0de/01-cover.png"/><meta data-react-helmet="true" name="twitter:url" content="https://trekhleb.dev/blog/2020/printed-links-detection/"/><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" title="Trekhleb.dev RSS Feed" href="/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-1310037a05e01c1b407b.js"/><link as="script" rel="preload" href="/framework-d63adeb7e1b44b7b8aa5.js"/><link as="script" rel="preload" href="/app-ab2a30ee84bb35ad4a6a.js"/><link as="script" rel="preload" href="/commons-92cda2548ad624e1d741.js"/><link as="script" rel="preload" href="/component---src-templates-post-tsx-c4045391b1a7c095d609.js"/><link as="fetch" rel="preload" href="/page-data/blog/2020/printed-links-detection/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><main class="flex flex-col items-center"><div class="max-w-screen-xl self-stretch m-auto w-full"><header class="flex flex-row items-center px-6 sm:px-12 py-6"><div class="mr-6"><div><a class="transition duration-200 ease-in-out flex flex-row items-center hover:text-red-600 font-extrabold text-sm tracking-widest uppercase" href="/">Trekhleb</a></div></div><nav><ul class="flex flex-row"><li class="ml-5"><a class="transition duration-200 ease-in-out flex flex-row items-center hover:text-red-600 uppercase text-xs" href="/">About</a></li><li class="ml-5"><a class="transition duration-200 ease-in-out flex flex-row items-center hover:text-red-600 uppercase text-xs" href="/projects/">Projects</a></li><li class="ml-5"><a class="transition duration-200 ease-in-out flex flex-row items-center hover:text-red-600 uppercase text-xs" href="/blog/">Blog</a></li></ul></nav></header><article class="px-6 sm:px-12 py-6"><div class="flex flex-col items-center"><article class="w-full prose prose-sm sm:prose overflow-hidden prose-red" style="max-width:860px"><h1 class="text-3xl mb-6 uppercase font-extrabold ">Making the Printed Links Clickable Using TensorFlow 2 Object Detection API</h1><div class="flex flex-row items-center "><div class="flex flex-row items-center mr-6"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-1" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>01 December, 2020</div><div class="flex flex-row items-center "><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="mr-1" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>22<!-- --> min to read</div></div><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:50%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACOklEQVQoz3XSS0sbURTA8TxGbRGKIAiuTVQC8fENFFwliAguBV0UQSJto3VT0UWFEigubakVs+nG1yJobWmmD2LSWEsbSlJDTDKdScYxKqaNX+BfcqPW0ro4nHsX98e55xyTyWTif2GxWERua2tjaWmJaDRKLBYjmUySTqdJJBLivrW1xfz8PMPDw1RXV5ff/EHMZvM/cGtrK36/n1Qqxd7eHvl8HsMw0HWdXC4n0EAggMfjwWq1/g1ehauqqsS5o6OD5eVlVFUVSKlUolgsUiqdcXpaFJHNKszMzFBTc15hXV0djY2NNDU1UV9fT19fH0NDQwJ0OBzIsiyQo6MjAZ6cnFAsnnJ29otCweDw8ACfz0dtbW0FdDqd9Pb2Mjg4SE9PD11dXbhcrssebmxsUCgU0DQVwzhGV3fIfn3A/ucp4uFJkjuT+GZHuHHzVgXs7OxkdHSU/v5+3G43AwMDdHd3X1a4srJCPqehKBk0LceBnuZADaNlQqQSQeKxl0xPjWM2n/ewoaFBoO3t7aKicthsNgHa7XYWFxdJfE+jqAaqZqCoh+T0n2R/HPMtniG0vYvXO47VaqmA5SGU16ScL86SJFXA5mbm5h6zn9gknwmiK28x1Hfoikw+GyQdXyf4+gVjY3eRpGumfDVs9mZmH04TeXWHD4ERPsledmUvX97fZ+fNPbY3bxNYfYRnbBxJslwPXuxkS0sLExMTPHn6jLW1dUKhbcLhCJHIR4JBmdXVNRYWnosZlH/1G7mPvzkUaAowAAAAAElFTkSuQmCC&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Links Detector Cover" title="Links Detector Cover" src="/static/745b6101a4bb0c212288c868617942b8/00d43/27.png" srcSet="/static/745b6101a4bb0c212288c868617942b8/63868/27.png 250w,/static/745b6101a4bb0c212288c868617942b8/0b533/27.png 500w,/static/745b6101a4bb0c212288c868617942b8/00d43/27.png 1000w,/static/745b6101a4bb0c212288c868617942b8/21b4d/27.png 1280w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><h2 id="-tldr" style="position:relative">📃 TL;DR<a href="#-tldr" aria-label=" tldr permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p><em>In this article we will start solving the issue of making the printed links (i.e. in a book or in a magazine) clickable via your smartphone camera.</em></p><p>We will use <a href="https://github.com/tensorflow/models/tree/master/research/object_detection">TensorFlow 2 Object Detection API</a> to train a custom object detector model to find positions and bounding boxes of the sub-strings like <code class="language-text">https://</code> in the text image (i.e. in smartphone camera stream).</p><p>The text of each link (right continuation of <code class="language-text">https://</code> bounding box) will be recognized by using <a href="https://tesseract.projectnaptha.com/">Tesseract</a> library. The recognition part will not be covered in this article, but you may find the complete code example of the application in <a href="https://github.com/trekhleb/links-detector">links-detector repository</a>.</p><blockquote><p>🚀 <a href="https://trekhleb.dev/links-detector/">Launch Links Detector demo</a> from your smartphone to see the final result.</p></blockquote><blockquote><p>📝 <a href="https://github.com/trekhleb/links-detector">Open links-detector repository</a> on GitHub to see the complete source code of the application.</p></blockquote><p>Here is how the final solution will look like:</p><p><img src="/posts-assets/4e839b39a53cf12e04da75a283aadc60/02-demo.gif" alt="Links Detector Demo"/></p><blockquote><p>⚠️ Currently the application is in <em>experimental</em> <em>Alpha</em> stage and has <a href="https://github.com/trekhleb/links-detector/issues?q=is%3Aopen+is%3Aissue+label%3Aenhancement">many issues and limitations</a>. So don&#x27;t raise your expectations level too high until these issues are resolved 🤷🏻‍. Also, the purpose of this article is more about learning how to work with TensorFlow 2 Object Detection API rather than coming up with a production-ready model.</p></blockquote><blockquote><p>In case if Python code blocks in this article will lack proper formatting on this platform feel free to <a href="https://github.com/trekhleb/links-detector/blob/master/articles/printed_links_detection/printed_links_detection.md">to read the article on GitHub</a></p></blockquote><h2 id="🤷️-the-problem" style="position:relative">🤷🏻‍️ The Problem<a href="#%F0%9F%A4%B7%EF%B8%8F-the-problem" aria-label="🤷️ the problem permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>I work as a software engineer and in my own time, I learn Machine Learning as a hobby. But this is not the problem yet.</p><p>I bought a printed book about Machine Learning recently and while I was reading through the first several chapters I&#x27;ve encountered many printed links in the text that looked like <code class="language-text">https://tensorflow.org/</code> or <code class="language-text">https://some-url.com/which/may/be/even/longer?and_with_params=true</code>.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:43.2%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBP/EABUBAQEAAAAAAAAAAAAAAAAAAAEA/9oADAMBAAIQAxAAAAHSgErR/8QAFhABAQEAAAAAAAAAAAAAAAAAACEg/9oACAEBAAEFAlXH/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGxAAAgEFAAAAAAAAAAAAAAAAAAFBEBExUXH/2gAIAQEAAT8hV90PoggeT//aAAwDAQACAAMAAAAQQN//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAEBAAIDAAAAAAAAAAAAAAABABAhQZGh/9oACAEBAAE/EEgT1OnPcg6jHE//2Q==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Printed Links" title="Printed Links" src="/static/0c4381cbec209c0614c9a8e89dc64425/a2510/0.jpg" srcSet="/static/0c4381cbec209c0614c9a8e89dc64425/0479a/0.jpg 250w,/static/0c4381cbec209c0614c9a8e89dc64425/41099/0.jpg 500w,/static/0c4381cbec209c0614c9a8e89dc64425/a2510/0.jpg 1000w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>I saw all these links, but I couldn&#x27;t click on them since they were printed (thanks, cap!). To visit these links I needed to start typing them character by character in the browser&#x27;s address bar, which was pretty annoying and error-prone.</p><h2 id="-possible-solution" style="position:relative">💡 Possible Solution<a href="#-possible-solution" aria-label=" possible solution permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>So, I was thinking, what if, similarly to QR-code detection, we will try to &quot;teach&quot; the smartphone to <em>(1)</em> <em>detect</em> and <em>(2)</em> <em>recognize</em> printed links for us and to make them <em>clickable</em>? This way you would do just one click instead of multiple keystrokes. The operational complexity of &quot;clicking&quot; the printed links goes from <code class="language-text">O(N)</code> to <code class="language-text">O(1)</code>.</p><p>This is how the final workflow will look like:</p><p><img src="/posts-assets/2dc300f4cc152c8b14200c25eba77a02/1.gif" alt="Links Detector Demo"/></p><h2 id="-solution-requirements" style="position:relative">📝 Solution Requirements<a href="#-solution-requirements" aria-label=" solution requirements permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>As I&#x27;ve mentioned earlier I&#x27;m just studying Machine Learning as a hobby. Thus, the purpose of this article is more about <em>learning</em> how to work with TensorFlow 2 Object Detection API rather than coming up with a production-ready application.</p><p>With that being said, I simplified the solution requirements to the following:</p><ol><li>The detection and recognition processes should have a <strong>close-to-real-time</strong> performance (i.e. <code class="language-text">0.5-1</code> frames per second) on a device like iPhone X. It means that the whole <em>detection + recognition</em> process should take up to <code class="language-text">2</code> seconds (pretty bearable as for the amateur project).</li><li>Only <strong>English</strong> links should be supported.</li><li>Only <strong>dark text</strong> (i.e. black or dark-grey) on <strong>light background</strong> (i.e. white or light-grey) should be supported.</li><li>Only <code class="language-text">https://</code> links should be supported for now (it is ok if our model will not recognize the <code class="language-text">http://</code>, <code class="language-text">ftp://</code>, <code class="language-text">tcp://</code> or other types of links).</li></ol><h2 id="🧩-solution-breakdown" style="position:relative">🧩 Solution Breakdown<a href="#%F0%9F%A7%A9-solution-breakdown" aria-label="🧩 solution breakdown permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><h3 id="high-level-breakdown" style="position:relative">High-level breakdown<a href="#high-level-breakdown" aria-label="high level breakdown permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>Let&#x27;s see how we could approach the problem on a high level.</p><h4 id="option-1-detection-model-on-the-back-end" style="position:relative">Option 1: Detection model on the back-end<a href="#option-1-detection-model-on-the-back-end" aria-label="option 1 detection model on the back end permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h4><p><strong>The flow:</strong></p><ol><li>Get camera stream (frame by frame) on the client-side.</li><li>Send each frame one by one over the network to the back-end.</li><li>Do link detection and recognition on the back-end and send the response back to the client.</li><li>Client draws the detection boxes with the clickable links.</li></ol><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:76.4%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAgABBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe4zg4x//8QAFxAAAwEAAAAAAAAAAAAAAAAAEBEhQv/aAAgBAQABBQLQVQ//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAWEAEBAQAAAAAAAAAAAAAAAAAQETH/2gAIAQEABj8C1r//xAAaEAADAQADAAAAAAAAAAAAAAAAARExQWFx/9oACAEBAAE/IY12cFRo6QVH6JOaf//aAAwDAQACAAMAAAAQsw//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAEAAwEBAQAAAAAAAAAAAAABABEhMUFh/9oACAEBAAE/EAFWloyWyjGCARseM1TnldlwNeiishyGT5P/2Q==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Model on the back-end" title="Model on the back-end" src="/static/b1008fc4187f646645a88963ab5d842e/a2510/2.jpg" srcSet="/static/b1008fc4187f646645a88963ab5d842e/0479a/2.jpg 250w,/static/b1008fc4187f646645a88963ab5d842e/41099/2.jpg 500w,/static/b1008fc4187f646645a88963ab5d842e/a2510/2.jpg 1000w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p><strong>Pros:</strong></p><ul><li>💚 The detection performance is not limited by the client&#x27;s device. We may speed the detection up by scaling the service horizontally (adding more instances) and vertically (adding more cores/GPUs).</li><li>💚 The model might be bigger since there is no need to upload it to the client-side. Downloading the <code class="language-text">~10Mb</code> model on the client-side may be ok, but loading the <code class="language-text">~100Mb</code> model might be a big issue for the client&#x27;s network and application UX (user experience) otherwise.</li><li>💚 It is possible to control who is using the model. Model is guarded behind the API, so we would have complete control over its callers/clients.</li></ul><p><strong>Cons:</strong></p><ul><li>💔 System complexity growth. The application tech stack grew from just <code class="language-text">JavaScript</code> to, let&#x27;s say, <code class="language-text">JavaScript + Python</code>. We need to take care of the autoscaling.</li><li>💔 Offline mode for the app is not possible since it needs an internet connection to work.</li><li>💔 Too many HTTP requests between the client and the server may become a bottleneck at some point. Imagine if we would want to improve the performance of the detection, let&#x27;s say, from <code class="language-text">1</code> to <code class="language-text">10+</code> frames per second. This means that each client will send <code class="language-text">10+</code> requests per second. For <code class="language-text">10</code> simultaneous clients it is already <code class="language-text">100+</code> requests per second. The <code class="language-text">HTTP/2</code> bidirectional streaming and <code class="language-text">gRPC</code> might be useful in this case, but we&#x27;re going back to the increased system complexity here.</li><li>💔 System becomes more expensive. Almost all points from the Pros section need to be paid for.</li></ul><h4 id="option-2-detection-model-on-the-front-end" style="position:relative">Option 2: Detection model on the front-end<a href="#option-2-detection-model-on-the-front-end" aria-label="option 2 detection model on the front end permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h4><p><strong>The flow:</strong></p><ol><li>Get camera stream (frame by frame) on the client-side.</li><li>Do link detection and recognition on the client-side (without sending anything to the back-end).</li><li>Client draws the detection boxes with the clickable links.</li></ol><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:104.4%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAVABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAECAwX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB7ldc41FRULA//8QAGhAAAgIDAAAAAAAAAAAAAAAAARAAEQISIv/aAAgBAQABBQLKC9kD0qX/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/Ah//xAAZEAEBAQADAAAAAAAAAAAAAAABERAAITH/2gAIAQEAAT8haHXH6WallNTbn//aAAwDAQACAAMAAAAQ7Ah8/8QAFREBAQAAAAAAAAAAAAAAAAAAEAH/2gAIAQMBAT8QIf/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EABkQAQEAAwEAAAAAAAAAAAAAAAERECFBAP/aAAgBAQABPxALvV560Oh3KkQVJ2GdbUXH/9k=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Model on the front-end" title="Model on the front-end" src="/static/9d35d51a8edae4727238f9dc487ab5e1/a2510/3.jpg" srcSet="/static/9d35d51a8edae4727238f9dc487ab5e1/0479a/3.jpg 250w,/static/9d35d51a8edae4727238f9dc487ab5e1/41099/3.jpg 500w,/static/9d35d51a8edae4727238f9dc487ab5e1/a2510/3.jpg 1000w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p><strong>Pros:</strong></p><ul><li>💚 System is less complex. We don&#x27;t need to set up the servers, build the API, and introduce an additional Python stack to the system.</li><li>💚 Offline mode is possible. The app doesn&#x27;t need an internet connection to work since the model is fully loaded to the device. So the Progressive Web Application (<a href="https://web.dev/progressive-web-apps/">PWA</a>) might be built to support that.</li><li>💚 System is &quot;kind of&quot; scaling automatically. The more clients you have, the more cores and GPUs they bring. This is not a proper scaling solution though (more about that in a Cons section below).</li><li>💚 System is cheaper. We only need a server for static assets (<code class="language-text">HTML</code>, <code class="language-text">JS</code>, <code class="language-text">CSS</code>, model files, etc.). This may be done for free, let&#x27;s say, on GitHub.</li><li>💚 No issue with the growing number of HTTP requests per second to the server-side.</li></ul><p><strong>Cons:</strong></p><ul><li>💔 Only horizontal scaling is possible (each client will have its own CPU/GPU). Vertical scaling is not possible since we can&#x27;t influence the client&#x27;s device performance. As a result, we can&#x27;t guarantee fast detection for low performant devices.</li><li>💔 It is not possible to guard the model usage and control the callers/clients of the model. Everyone could download the model and re-use it.</li><li>💔 Battery consumption of the client&#x27;s device might become an issue. For the model to work it needs computational resources. So clients might not be happy with their iPhone getting warmer and warmer while the app is working.</li></ul><h4 id="high-level-conclusion" style="position:relative">High-level conclusion<a href="#high-level-conclusion" aria-label="high level conclusion permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h4><p>Since the purpose of the project was more about learning and not coming up with a production-ready solution <em>I decided to go with the second option of serving the model from the client side</em>. This made the whole project much cheaper (actually with GitHub it was free to host it), and I could focus more on Machine Learning than on the autoscaling back-end infrastructure.</p><h3 id="lower-level-breakdown" style="position:relative">Lower level breakdown<a href="#lower-level-breakdown" aria-label="lower level breakdown permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>Ok, so we&#x27;ve decided to go with the serverless solution. Now we have an image from the camera stream as an input that looks something like this:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:100%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBP/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHrmbGmAgUL/8QAGRAAAwADAAAAAAAAAAAAAAAAAAERECAh/9oACAEBAAEFAsd1rKz/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/Ah//xAAdEAACAQQDAAAAAAAAAAAAAAAAAREhMVFhEJHw/9oACAEBAAE/IZeSXlnlS/HQqK7NxsP/2gAMAwEAAgADAAAAEMTXfP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EAB0QAQEBAAICAwAAAAAAAAAAAAERACFhMXFBkdH/2gAIAQEAAT8QasU95q4nfChQZfjcj2dal5r3qBPsyDw/MyT+N//Z&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Printed Links Input" title="Printed Links Input" src="/static/ad6a433499d46bf50b63d69734154c37/a2510/4.jpg" srcSet="/static/ad6a433499d46bf50b63d69734154c37/0479a/4.jpg 250w,/static/ad6a433499d46bf50b63d69734154c37/41099/4.jpg 500w,/static/ad6a433499d46bf50b63d69734154c37/a2510/4.jpg 1000w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>We need to solve two sub-tasks for this image:</p><ol><li>Links <strong>detection</strong> (finding the position and bounding boxes of the links)</li><li>Links <strong>recognition</strong> (recognizing the text of the links)</li></ol><h4 id="option-1-tesseract-based-solution" style="position:relative">Option 1: Tesseract based solution<a href="#option-1-tesseract-based-solution" aria-label="option 1 tesseract based solution permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h4><p>The first and the most obvious approach would be to solve the <em>Optical Character Recognition</em> (<a href="https://en.wikipedia.org/wiki/Optical_character_recognition">OCR</a>) task by recognizing the whole text of the image by using, let&#x27;s say, <a href="https://github.com/naptha/tesseract.js">Tesseract.js</a> library. It returns the bounding boxes of the paragraphs, text lines, and text blocks along with the recognized text.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:99.6%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBP/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHryNltAnQoH//EABkQAAIDAQAAAAAAAAAAAAAAAAAhARESIP/aAAgBAQABBQJjHzqSz//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABoQAAIDAQEAAAAAAAAAAAAAAAABETFREIH/2gAIAQEAAT8hnTJ0z2X1NpWxSWSP/9oADAMBAAIAAwAAABAA2EH/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EB//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EB//xAAeEAEBAQABBAMAAAAAAAAAAAABEQBBITFhkVFx0f/aAAgBAQABPxBsyF+c2bgJ/WrSWXjVHyYbez9upj3ZKOHTec9G/9k=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Recognized text with bounding boxes" title="Recognized text with bounding boxes" src="/static/a2b20844e61c8aff72a78bd9777f23ce/a2510/5.jpg" srcSet="/static/a2b20844e61c8aff72a78bd9777f23ce/0479a/5.jpg 250w,/static/a2b20844e61c8aff72a78bd9777f23ce/41099/5.jpg 500w,/static/a2b20844e61c8aff72a78bd9777f23ce/a2510/5.jpg 1000w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>We may try then to extract the links from the recognized text lines or text blocks with a regular expression like <a href="https://stackoverflow.com/questions/3809401/what-is-a-good-regular-expression-to-match-a-url">this one</a> (example is on TypeScript):</p><div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> <span class="token constant">URL_REG_EXP</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{2,256}\.[a-z]{2,4}\b([-a-zA-Z0-9@:%_+.~#?&amp;/=]*)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gi</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> extractLinkFromText <span class="token operator">=</span> <span class="token punctuation">(</span>text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> urls<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token constant">URL_REG_EXP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>urls <span class="token operator">||</span> <span class="token operator">!</span>urls<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> urls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div><p>💚 Seems like the issue is solved in a pretty straightforward and simple way:</p><ul><li>We know the bounding boxes of the links</li><li>We also know the text of the links to make them clickable</li></ul><p>💔 The thing is that the <em>recognition + detection</em> time may vary from <code class="language-text">2</code> to <code class="language-text">20+</code> seconds depending on the size of the text, on the amount of &quot;something that looks like a text&quot; on the image, on the image quality and on other factors. So it will be really hard to achieve those <code class="language-text">0.5-1</code> frames per second to make the user experience at least <em>close</em> to real-time.</p><p>💔 Also if we would think about it, we&#x27;re asking the library to recognize the <strong>whole</strong> text from the image for us even though it might contain only one or two links in it (i.e. only ~10% of the text might be useful for us), or it may even not contain the links at all. In this case, it sounds like a waste of computational resources.</p><h4 id="option-2-tesseract--tensorflow-based-solution" style="position:relative">Option 2: Tesseract + TensorFlow based solution<a href="#option-2-tesseract--tensorflow-based-solution" aria-label="option 2 tesseract  tensorflow based solution permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h4><p>We could make Tesseract work faster if we used some <em>additional &quot;adviser&quot; algorithm</em> prior to the links text recognition. This &quot;adviser&quot; algorithm should detect, but not recognize, <em>the leftmost position</em> of each link on the image if there are any. This will allow us to speed up the recognition part by following these rules:</p><ol><li>If the image does not contain any link we should not call Tesseract detection/recognition at all.</li><li>If the image does have the links then we need to ask Tesseract to recognize only those parts of the image that contains the links. We&#x27;re not interested in spending the time for recognition of the irrelevant text that does not contain the links.</li></ol><p>The &quot;adviser&quot; algorithm that will take place before the Tesseract should work with a constant time regardless of the image quality, or the presence/absence of the text on the image. It also should be pretty fast and detect the leftmost positions of the links for less than <code class="language-text">1s</code> so that we could satisfy the &quot;close-to-real-time&quot; requirement (i.e. on iPhone X).</p><blockquote><p>💡 So what if we will use another object detection model to help us find all occurrences of the <code class="language-text">https://</code> substrings (every secure link has this prefix, doesn&#x27;t it) in the image? Then, having these <code class="language-text">https://</code> bounding boxes in the text we may extract the right-side continuation of them and send them to the Tesseract for text recognition.</p></blockquote><p>Take a look at the picture below:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:55.99999999999999%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHYschDD//EABkQAAEFAAAAAAAAAAAAAAAAAAEAERIgIv/aAAgBAQABBQLUi6FP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFRABAQAAAAAAAAAAAAAAAAAAIEH/2gAIAQEABj8Cq//EABkQAAIDAQAAAAAAAAAAAAAAABARACExgf/aAAgBAQABPyHiYM3Ef//aAAwDAQACAAMAAAAQfM//xAAVEQEBAAAAAAAAAAAAAAAAAAAQMf/aAAgBAwEBPxCH/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAR/9oACAECAQE/EF2f/8QAHBABAAICAwEAAAAAAAAAAAAAAQARITEQQVFx/9oACAEBAAE/EF0PxtVceGEe6yRKsrvuIVv32GuP/9k=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Tesseract and TensorFlow based solution" title="Tesseract and TensorFlow based solution" src="/static/6ef7e472afd39bfe0d1b7508449d6144/a2510/6.jpg" srcSet="/static/6ef7e472afd39bfe0d1b7508449d6144/0479a/6.jpg 250w,/static/6ef7e472afd39bfe0d1b7508449d6144/41099/6.jpg 500w,/static/6ef7e472afd39bfe0d1b7508449d6144/a2510/6.jpg 1000w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>You may notice that Tesseract needs to do <strong>much less</strong> work in case if it would have some hints about where are the links might be located (see the number of blue boxes on both pictures).</p><p>So the question now is which object detection model we should choose and how to re-train it to support the detection of the custom <code class="language-text">https://</code> objects.</p><blockquote><p>Finally! We&#x27;ve got closer to the TensorFlow part of the article 😀</p></blockquote><h2 id="-selecting-the-object-detection-model" style="position:relative">🤖 Selecting the Object Detection Model<a href="#-selecting-the-object-detection-model" aria-label=" selecting the object detection model permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>Training a new object detection model is not a reasonable option in our context because of the following reasons:</p><ul><li>💔 The training process might take days/weeks and bucks.</li><li>💔 We most probably won&#x27;t be able to collect hundreds of thousands of <em>labeled</em> images of the books that have links in them (we might try to generate them though, but more about that later).</li></ul><p>So instead of creating a new model, we should better teach an existing object detection model to do the custom object detection for us (to do the <a href="https://en.wikipedia.org/wiki/Transfer_learning">transfer learning</a>). In our case, the &quot;custom objects&quot; would be the images with <code class="language-text">https://</code> text drawn in them. This approach has the following benefits:</p><ul><li>💚 The dataset might be much smaller. We don&#x27;t need to collect hundreds of thousands of the labeled images. Instead, we may do <code class="language-text">~100</code> pictures and label them manually. This is because the model is already pre-trained on the general dataset like <a href="https://cocodataset.org/#home">COCO dataset</a> and already learned how to extract general image features.</li><li>💚 The training process will be much faster (minutes/hours on GPU instead of days/weeks). Again, this is because of a smaller dataset (smaller batches) and because of fewer trainable parameters.</li></ul><p>We may choose the existing model from <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md">TensorFlow 2 Detection Model Zoo</a> which provides a collection of detection models pre-trained on the <a href="https://cocodataset.org/#home">COCO 2017 dataset</a>. Now it contains <code class="language-text">~40</code> model variations to choose from.</p><p>To re-train and fine-tune the model on the custom dataset we will use a <a href="https://github.com/tensorflow/models/tree/master/research/object_detection">TensorFlow 2 Object Detection API</a>. The TensorFlow Object Detection API is an open-source framework built on top of <a href="https://www.tensorflow.org/">TensorFlow</a> that makes it easy to construct, train, and deploy object detection models.</p><p>If you follow the <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md">Model Zoo</a> link you will find the <em>detection speed</em> and <em>accuracy</em> for each model.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:96.80000000000001%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAATABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAECAwX/xAAVAQEBAAAAAAAAAAAAAAAAAAABAP/aAAwDAQACEAMQAAAB9uzUFTz2JQP/xAAXEAEBAQEAAAAAAAAAAAAAAAAAAREg/9oACAEBAAEFAmInMf/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABoQAQEAAgMAAAAAAAAAAAAAAAEAIUEQETH/2gAIAQEAAT8h7zIcpw9TFuba/9oADAMBAAIAAwAAABA8B0D/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxAhP//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAECAQE/EGM//8QAHBABAAICAwEAAAAAAAAAAAAAAQAxESFxkbGB/9oACAEBAAE/EMmzpjWAutxOHlludy3XsJh0WwU+pbr2U5M//9k=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Model Zoo" title="Model Zoo" src="/static/f01df6492b87597aa9333c853eaa333b/a2510/7.jpg" srcSet="/static/f01df6492b87597aa9333c853eaa333b/0479a/7.jpg 250w,/static/f01df6492b87597aa9333c853eaa333b/41099/7.jpg 500w,/static/f01df6492b87597aa9333c853eaa333b/a2510/7.jpg 1000w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p><em>Image source: <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md">TensorFlow Model Zoo</a> repository</em></p><p>Of course, we would want to find the right balance between the detection <strong>speed</strong> and <strong>accuracy</strong> while picking the model. But what might be even more important in our case is the <strong>size</strong> of the model since it will be loaded to the client-side.</p><p>The size of the archived model might vary drastically from <code class="language-text">~20Mb</code> to <code class="language-text">~1Gb</code>. Here are several examples:</p><ul><li><code class="language-text">1386 (Mb)</code> <code class="language-text">centernet_hg104_1024x1024_kpts_coco17_tpu-32</code></li><li><code class="language-text"> 330 (Mb)</code> <code class="language-text">centernet_resnet101_v1_fpn_512x512_coco17_tpu-8</code></li><li><code class="language-text"> 195 (Mb)</code> <code class="language-text">centernet_resnet50_v1_fpn_512x512_coco17_tpu-8</code></li><li><code class="language-text"> 198 (Mb)</code> <code class="language-text">centernet_resnet50_v1_fpn_512x512_kpts_coco17_tpu-8</code></li><li><code class="language-text"> 227 (Mb)</code> <code class="language-text">centernet_resnet50_v2_512x512_coco17_tpu-8</code></li><li><code class="language-text"> 230 (Mb)</code> <code class="language-text">centernet_resnet50_v2_512x512_kpts_coco17_tpu-8</code></li><li><code class="language-text">  29 (Mb)</code> <code class="language-text">efficientdet_d0_coco17_tpu-32</code></li><li><code class="language-text">  49 (Mb)</code> <code class="language-text">efficientdet_d1_coco17_tpu-32</code></li><li><code class="language-text">  60 (Mb)</code> <code class="language-text">efficientdet_d2_coco17_tpu-32</code></li><li><code class="language-text">  89 (Mb)</code> <code class="language-text">efficientdet_d3_coco17_tpu-32</code></li><li><code class="language-text"> 151 (Mb)</code> <code class="language-text">efficientdet_d4_coco17_tpu-32</code></li><li><code class="language-text"> 244 (Mb)</code> <code class="language-text">efficientdet_d5_coco17_tpu-32</code></li><li><code class="language-text"> 376 (Mb)</code> <code class="language-text">efficientdet_d6_coco17_tpu-32</code></li><li><code class="language-text"> 376 (Mb)</code> <code class="language-text">efficientdet_d7_coco17_tpu-32</code></li><li><code class="language-text"> 665 (Mb)</code> <code class="language-text">extremenet</code></li><li><code class="language-text"> 427 (Mb)</code> <code class="language-text">faster_rcnn_inception_resnet_v2_1024x1024_coco17_tpu-8</code></li><li><code class="language-text"> 424 (Mb)</code> <code class="language-text">faster_rcnn_inception_resnet_v2_640x640_coco17_tpu-8</code></li><li><code class="language-text"> 337 (Mb)</code> <code class="language-text">faster_rcnn_resnet101_v1_1024x1024_coco17_tpu-8</code></li><li><code class="language-text"> 337 (Mb)</code> <code class="language-text">faster_rcnn_resnet101_v1_640x640_coco17_tpu-8</code></li><li><code class="language-text"> 343 (Mb)</code> <code class="language-text">faster_rcnn_resnet101_v1_800x1333_coco17_gpu-8</code></li><li><code class="language-text"> 449 (Mb)</code> <code class="language-text">faster_rcnn_resnet152_v1_1024x1024_coco17_tpu-8</code></li><li><code class="language-text"> 449 (Mb)</code> <code class="language-text">faster_rcnn_resnet152_v1_640x640_coco17_tpu-8</code></li><li><code class="language-text"> 454 (Mb)</code> <code class="language-text">faster_rcnn_resnet152_v1_800x1333_coco17_gpu-8</code></li><li><code class="language-text"> 202 (Mb)</code> <code class="language-text">faster_rcnn_resnet50_v1_1024x1024_coco17_tpu-8</code></li><li><code class="language-text"> 202 (Mb)</code> <code class="language-text">faster_rcnn_resnet50_v1_640x640_coco17_tpu-8</code></li><li><code class="language-text"> 207 (Mb)</code> <code class="language-text">faster_rcnn_resnet50_v1_800x1333_coco17_gpu-8</code></li><li><code class="language-text"> 462 (Mb)</code> <code class="language-text">mask_rcnn_inception_resnet_v2_1024x1024_coco17_gpu-8</code></li><li><code class="language-text">  86 (Mb)</code> <code class="language-text">ssd_mobilenet_v1_fpn_640x640_coco17_tpu-8</code></li><li><code class="language-text">  44 (Mb)</code> <code class="language-text">ssd_mobilenet_v2_320x320_coco17_tpu-8</code></li><li><code class="language-text">  20 (Mb)</code> <code class="language-text">ssd_mobilenet_v2_fpnlite_320x320_coco17_tpu-8</code></li><li><code class="language-text">  20 (Mb)</code> <code class="language-text">ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8</code></li><li><code class="language-text"> 369 (Mb)</code> <code class="language-text">ssd_resnet101_v1_fpn_1024x1024_coco17_tpu-8</code></li><li><code class="language-text"> 369 (Mb)</code> <code class="language-text">ssd_resnet101_v1_fpn_640x640_coco17_tpu-8</code></li><li><code class="language-text"> 481 (Mb)</code> <code class="language-text">ssd_resnet152_v1_fpn_1024x1024_coco17_tpu-8</code></li><li><code class="language-text"> 480 (Mb)</code> <code class="language-text">ssd_resnet152_v1_fpn_640x640_coco17_tpu-8</code></li><li><code class="language-text"> 233 (Mb)</code> <code class="language-text">ssd_resnet50_v1_fpn_1024x1024_coco17_tpu-8</code></li><li><code class="language-text"> 233 (Mb)</code> <code class="language-text">ssd_resnet50_v1_fpn_640x640_coco17_tpu-8</code></li></ul><p>The <strong><code class="language-text">ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8</code></strong> model might be a good fit in our case:</p><ul><li>💚 It is relatively lightweight: <code class="language-text">20Mb</code> archived.</li><li>💚 It is pretty fast: <code class="language-text">39ms</code> for the detection.</li><li>💚 It uses the MobileNet v2 network as a feature extractor which is optimized for usage on mobile devices to reduce energy consumption.</li><li>💚 It does the object detection for the whole image and for all objects in it <strong>in one go</strong> regardless of the image content (no <a href="https://en.wikipedia.org/wiki/Region_Based_Convolutional_Neural_Networks">regions proposal</a> step is involved which makes the detection faster).</li><li>💔 It is not the most accurate model though (everything is a tradeoff ⚖️).</li></ul><p>The model name encodes some several important characteristics that you may read more about if you want:</p><ul><li>The expected image input size is <code class="language-text">640x640px</code>.</li><li>The model implements <a href="https://arxiv.org/abs/1512.02325">Single Shot MultiBox Detector</a> (SSD) and <a href="https://arxiv.org/abs/1612.03144">Feature Pyramid Network</a> (FPN).</li><li><a href="https://ai.googleblog.com/2018/04/mobilenetv2-next-generation-of-on.html">MobileNet v2</a> convolutional neural network (<a href="https://en.wikipedia.org/wiki/Convolutional_neural_network">CNN</a>) is used as a feature extractor.</li><li>The model was trained on <a href="https://cocodataset.org/#home">COCO dataset</a></li></ul><h2 id="-installing-object-detection-api" style="position:relative">🛠 Installing Object Detection API<a href="#-installing-object-detection-api" aria-label=" installing object detection api permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>In this article, we&#x27;re going to install the Tensorflow 2 Object Detection API <em>as a Python package</em>. It is convenient in case if you&#x27;re experimenting in <a href="https://colab.research.google.com/">Google Colab</a> (recommended) or in <a href="https://jupyter.org/try">Jupyter</a>. For both cases no local installation is needed, you may experiment right in your browser.</p><p>You may also follow the <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2.md">official documentation</a> if you would prefer to install Object Detection API via Docker.</p><blockquote><p>If you stuck with something during the API installation or during the dataset preparation try to read through the <a href="https://tensorflow-object-detection-api-tutorial.readthedocs.io/en/latest/index.html">TensorFlow 2 Object Detection API tutorial</a> which adds a lot of useful details to this process.</p></blockquote><p>First, let&#x27;s clone the <a href="https://github.com/tensorflow/models">API repository</a>:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">git</span> clone --depth <span class="token number">1</span> https://github.com/tensorflow/models</code></pre></div><p><em>output →</em></p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Cloning into &#x27;models&#x27;...
remote: Enumerating objects: 2301, done.
remote: Counting objects: 100% (2301/2301), done.
remote: Compressing objects: 100% (2000/2000), done.
remote: Total 2301 (delta 561), reused 922 (delta 278), pack-reused 0
Receiving objects: 100% (2301/2301), 30.60 MiB | 13.90 MiB/s, done.
Resolving deltas: 100% (561/561), done.</code></pre></div><p>Now, let&#x27;s compile the <a href="https://github.com/tensorflow/models/tree/master/research/object_detection/protos">API proto files</a> into Python files by using <a href="https://grpc.io/docs/protoc-installation/">protoc</a> tool:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ./models/research
protoc object_detection/protos/*.proto --python_out<span class="token operator">=</span>.</code></pre></div><p>Finally, let&#x27;s install the TF2 version of <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/packages/tf2/setup.py">setup.py</a> via <code class="language-text">pip</code>:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">cp</span> ./object_detection/packages/tf2/setup.py <span class="token builtin class-name">.</span>
pip <span class="token function">install</span> <span class="token builtin class-name">.</span> --quiet</code></pre></div><blockquote><p>It is possible that the last step will fail because of some dependency errors. In this case, you might want to run <code class="language-text">pip install . --quiet</code> one more time.</p></blockquote><p>We may test that installation went successfully by running the following tests:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">python object_detection/builders/model_builder_tf2_test.py</code></pre></div><p>You should see the logs that end with something similar to this:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">[       OK ] ModelBuilderTF2Test.test_unknown_ssd_feature_extractor
----------------------------------------------------------------------
Ran 20 tests in 45.072s

OK (skipped=1)</code></pre></div><p>The TensorFlow Object Detection API is installed! You may now use the scripts that API provides for doing the model <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/colab_tutorials/inference_tf2_colab.ipynb">inference</a>, <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_training_and_evaluation.md">training</a> or <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/colab_tutorials/eager_few_shot_od_training_tf2_colab.ipynb">fine-tuning</a>.</p><h2 id="️-downloading-the-pre-trained-model" style="position:relative">⬇️ Downloading the Pre-Trained Model<a href="#%EF%B8%8F-downloading-the-pre-trained-model" aria-label="️ downloading the pre trained model permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>Let&#x27;s download our selected <code class="language-text">ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8</code> model from the TensorFlow Model Zoo and check how it does the general object detection (detection of the objects of classes from COCO dataset like &quot;cat&quot;, &quot;dog&quot;, &quot;car&quot;, etc.).</p><p>We will use the <a href="https://www.tensorflow.org/api_docs/python/tf/keras/utils/get_file">get_file()</a> TensorFlow helper to download the archived model from the URL and unpack it.</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> pathlib

MODEL_NAME <span class="token operator">=</span> <span class="token string">&#x27;ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8&#x27;</span>
TF_MODELS_BASE_PATH <span class="token operator">=</span> <span class="token string">&#x27;http://download.tensorflow.org/models/object_detection/tf2/20200711/&#x27;</span>
CACHE_FOLDER <span class="token operator">=</span> <span class="token string">&#x27;./cache&#x27;</span>

<span class="token keyword">def</span> <span class="token function">download_tf_model</span><span class="token punctuation">(</span>model_name<span class="token punctuation">,</span> cache_folder<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model_url <span class="token operator">=</span> TF_MODELS_BASE_PATH <span class="token operator">+</span> model_name <span class="token operator">+</span> <span class="token string">&#x27;.tar.gz&#x27;</span>
    model_dir <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>get_file<span class="token punctuation">(</span>
        fname<span class="token operator">=</span>model_name<span class="token punctuation">,</span>
        origin<span class="token operator">=</span>model_url<span class="token punctuation">,</span>
        untar<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        cache_dir<span class="token operator">=</span>pathlib<span class="token punctuation">.</span>Path<span class="token punctuation">(</span>cache_folder<span class="token punctuation">)</span><span class="token punctuation">.</span>absolute<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> model_dir

<span class="token comment"># Start the model download.</span>
model_dir <span class="token operator">=</span> download_tf_model<span class="token punctuation">(</span>MODEL_NAME<span class="token punctuation">,</span> CACHE_FOLDER<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>model_dir<span class="token punctuation">)</span></code></pre></div><p><em>output →</em></p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">/content/cache/datasets/ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8</code></pre></div><p>Here is how the folder structure looks so far:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:972px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:80%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAgAF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB22EKo//EABcQAAMBAAAAAAAAAAAAAAAAAAECECH/2gAIAQEAAQUCOVr/AP/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABwQAQACAgMBAAAAAAAAAAAAAAERIQAQMUGR8f/aAAgBAQABPyGTrhwV+aswW4T3Pmv/2gAMAwEAAgADAAAAEKPP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBABAAIDAAMAAAAAAAAAAAAAAQARMUFRYXGR/9oACAEBAAE/EFZV6HswCfU9xBDRlNeIwFrcwg2bn//Z&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Cache Folder" title="Cache Folder" src="/static/ba6e6aef4124664efef1f1af4f1f9c95/95c6e/8.jpg" srcSet="/static/ba6e6aef4124664efef1f1af4f1f9c95/0479a/8.jpg 250w,/static/ba6e6aef4124664efef1f1af4f1f9c95/41099/8.jpg 500w,/static/ba6e6aef4124664efef1f1af4f1f9c95/95c6e/8.jpg 972w" sizes="(max-width: 972px) 100vw, 972px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>The <code class="language-text">checkpoint</code> folder contains the snapshot of the pre-trained model.</p><p>The <code class="language-text">pipeline.config</code> file contains the detection settings of the model. We&#x27;ll come back to this file later when we will need to fine-tune the model.</p><h2 id="️-trying-the-model-doing-the-inference" style="position:relative">🏄🏻‍️ Trying the Model (Doing the Inference)<a href="#%EF%B8%8F-trying-the-model-doing-the-inference" aria-label="️ trying the model doing the inference permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>For now, the model can detect the object of <a href="https://cocodataset.org/#explore">90 COCO dataset classes</a> like a <code class="language-text">car</code>, <code class="language-text">bird</code>, <code class="language-text">hot dog</code> etc.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:22.799999999999997%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB06Cwf//EABkQAAMAAwAAAAAAAAAAAAAAAAABAhESE//aAAgBAQABBQKo1FGXyP/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABgQAAIDAAAAAAAAAAAAAAAAAAARASGB/9oACAEBAAY/AmzCpP/EABgQAQEBAQEAAAAAAAAAAAAAAAERADFB/9oACAEBAAE/IZoS3AAr60HQ3//aAAwDAQACAAMAAAAQ8A//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAEAAgIDAAAAAAAAAAAAAAABABEhQTFR4f/aAAgBAQABPxA7za2vBS17KktOLuYQJvdvc//Z&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="COCO classes" title="COCO classes" src="/static/43edaafc7d30b56f3421efff4cac6d42/a2510/9.jpg" srcSet="/static/43edaafc7d30b56f3421efff4cac6d42/0479a/9.jpg 250w,/static/43edaafc7d30b56f3421efff4cac6d42/41099/9.jpg 500w,/static/43edaafc7d30b56f3421efff4cac6d42/a2510/9.jpg 1000w,/static/43edaafc7d30b56f3421efff4cac6d42/c58a3/9.jpg 1500w,/static/43edaafc7d30b56f3421efff4cac6d42/d14d4/9.jpg 1562w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p><em>Image source: <a href="https://cocodataset.org/#explore">COCO dataset</a> website</em></p><p>Let&#x27;s see how the model performs on some general images that contain the objects of these classes.</p><h3 id="loading-coco-labels" style="position:relative">Loading COCO labels<a href="#loading-coco-labels" aria-label="loading coco labels permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>Object Detection API already has a complete set of COCO labels (classes) defined for us.</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os

<span class="token comment"># Import Object Detection API helpers.</span>
<span class="token keyword">from</span> object_detection<span class="token punctuation">.</span>utils <span class="token keyword">import</span> label_map_util

<span class="token comment"># Loads the COCO labels data (class names and indices relations).</span>
<span class="token keyword">def</span> <span class="token function">load_coco_labels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Object Detection API already has a complete set of COCO classes defined for us.</span>
    label_map_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>
        <span class="token string">&#x27;models/research/object_detection/data&#x27;</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;mscoco_complete_label_map.pbtxt&#x27;</span>
    <span class="token punctuation">)</span>
    label_map <span class="token operator">=</span> label_map_util<span class="token punctuation">.</span>load_labelmap<span class="token punctuation">(</span>label_map_path<span class="token punctuation">)</span>

    <span class="token comment"># Class ID to Class Name mapping.</span>
    categories <span class="token operator">=</span> label_map_util<span class="token punctuation">.</span>convert_label_map_to_categories<span class="token punctuation">(</span>
        label_map<span class="token punctuation">,</span>
        max_num_classes<span class="token operator">=</span>label_map_util<span class="token punctuation">.</span>get_max_label_map_index<span class="token punctuation">(</span>label_map<span class="token punctuation">)</span><span class="token punctuation">,</span>
        use_display_name<span class="token operator">=</span><span class="token boolean">True</span>
    <span class="token punctuation">)</span>
    category_index <span class="token operator">=</span> label_map_util<span class="token punctuation">.</span>create_category_index<span class="token punctuation">(</span>categories<span class="token punctuation">)</span>

    <span class="token comment"># Class Name to Class ID mapping.</span>
    label_map_dict <span class="token operator">=</span> label_map_util<span class="token punctuation">.</span>get_label_map_dict<span class="token punctuation">(</span>label_map<span class="token punctuation">,</span> use_display_name<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> category_index<span class="token punctuation">,</span> label_map_dict

<span class="token comment"># Load COCO labels.</span>
coco_category_index<span class="token punctuation">,</span> coco_label_map_dict <span class="token operator">=</span> load_coco_labels<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;coco_category_index:&#x27;</span><span class="token punctuation">,</span> coco_category_index<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;coco_label_map_dict:&#x27;</span><span class="token punctuation">,</span> coco_label_map_dict<span class="token punctuation">)</span></code></pre></div><p><em>output →</em></p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">coco_category_index:
{
    1: {&#x27;id&#x27;: 1, &#x27;name&#x27;: &#x27;person&#x27;},
    2: {&#x27;id&#x27;: 2, &#x27;name&#x27;: &#x27;bicycle&#x27;},
    ...
    90: {&#x27;id&#x27;: 90, &#x27;name&#x27;: &#x27;toothbrush&#x27;},
}

coco_label_map_dict:
{
    &#x27;background&#x27;: 0,
    &#x27;person&#x27;: 1,
    &#x27;bicycle&#x27;: 2,
    &#x27;car&#x27;: 3,
    ...
    &#x27;toothbrush&#x27;: 90,
}</code></pre></div><h3 id="build-a-detection-function" style="position:relative">Build a detection function<a href="#build-a-detection-function" aria-label="build a detection function permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>We need to create a detection function that will use the pre-trained model we&#x27;ve downloaded to do the object detection.</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

<span class="token comment"># Import Object Detection API helpers.</span>
<span class="token keyword">from</span> object_detection<span class="token punctuation">.</span>utils <span class="token keyword">import</span> config_util
<span class="token keyword">from</span> object_detection<span class="token punctuation">.</span>builders <span class="token keyword">import</span> model_builder

<span class="token comment"># Generates the detection function for specific model and specific model&#x27;s checkpoint</span>
<span class="token keyword">def</span> <span class="token function">detection_fn_from_checkpoint</span><span class="token punctuation">(</span>config_path<span class="token punctuation">,</span> checkpoint_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Build the model.</span>
    pipeline_config <span class="token operator">=</span> config_util<span class="token punctuation">.</span>get_configs_from_pipeline_file<span class="token punctuation">(</span>config_path<span class="token punctuation">)</span>
    model_config <span class="token operator">=</span> pipeline_config<span class="token punctuation">[</span><span class="token string">&#x27;model&#x27;</span><span class="token punctuation">]</span>
    model <span class="token operator">=</span> model_builder<span class="token punctuation">.</span>build<span class="token punctuation">(</span>
        model_config<span class="token operator">=</span>model_config<span class="token punctuation">,</span>
        is_training<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># Restore checkpoints.</span>
    ckpt <span class="token operator">=</span> tf<span class="token punctuation">.</span>compat<span class="token punctuation">.</span>v2<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Checkpoint<span class="token punctuation">(</span>model<span class="token operator">=</span>model<span class="token punctuation">)</span>
    ckpt<span class="token punctuation">.</span>restore<span class="token punctuation">(</span>checkpoint_path<span class="token punctuation">)</span><span class="token punctuation">.</span>expect_partial<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># This is a function that will do the detection.</span>
    <span class="token decorator annotation punctuation">@tf<span class="token punctuation">.</span>function</span>
    <span class="token keyword">def</span> <span class="token function">detect_fn</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
        image<span class="token punctuation">,</span> shapes <span class="token operator">=</span> model<span class="token punctuation">.</span>preprocess<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        prediction_dict <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>image<span class="token punctuation">,</span> shapes<span class="token punctuation">)</span>
        detections <span class="token operator">=</span> model<span class="token punctuation">.</span>postprocess<span class="token punctuation">(</span>prediction_dict<span class="token punctuation">,</span> shapes<span class="token punctuation">)</span>

        <span class="token keyword">return</span> detections<span class="token punctuation">,</span> prediction_dict<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>shapes<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> detect_fn

inference_detect_fn <span class="token operator">=</span> detection_fn_from_checkpoint<span class="token punctuation">(</span>
    config_path<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">&#x27;cache&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;datasets&#x27;</span><span class="token punctuation">,</span> MODEL_NAME<span class="token punctuation">,</span> <span class="token string">&#x27;pipeline.config&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    checkpoint_path<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">&#x27;cache&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;datasets&#x27;</span><span class="token punctuation">,</span> MODEL_NAME<span class="token punctuation">,</span> <span class="token string">&#x27;checkpoint&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;ckpt-0&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre></div><p>This <code class="language-text">inference_detect_fn</code> function will accept an image and will return the detected objects&#x27; info.</p><h3 id="loading-the-images-for-inference" style="position:relative">Loading the images for inference<a href="#loading-the-images-for-inference" aria-label="loading the images for inference permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>Let&#x27;s try to detect the object on this image:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:640px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:100%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQDAv/EABcBAQEBAQAAAAAAAAAAAAAAAAECAAP/2gAMAwEAAhADEAAAAc9eNQ7Ts0zFFAjr/8QAHRAAAgIBBQAAAAAAAAAAAAAAAQIAEhETFCEiMf/aAAgBAQABBQICajLNw8VWzTueSPLFnoJ//8QAGBEAAgMAAAAAAAAAAAAAAAAAAAEQETH/2gAIAQMBAT8BKFsf/8QAFREBAQAAAAAAAAAAAAAAAAAAEiD/2gAIAQIBAT8BMf/EAB0QAQABAwUAAAAAAAAAAAAAAAEAEBFBAiExQlH/2gAIAQEABj8Cd0ljWzEPJfrmqPFP/8QAHRABAAMAAQUAAAAAAAAAAAAAAQARITEQUWFx0f/aAAgBAQABPyEUt4gXCjiHFQr+JSM744EwcnJRGukObDhPdP/aAAwDAQACAAMAAAAQlNdA/8QAFhEBAQEAAAAAAAAAAAAAAAAAEQAQ/9oACAEDAQE/EHQX/8QAGBEBAAMBAAAAAAAAAAAAAAAAAAERMVH/2gAIAQIBAT8QKnqcW//EAB4QAAICAgIDAAAAAAAAAAAAAAERADEhQVFxYYGx/9oACAEBAAE/EBcmOCQLuMy7x/OoSDDbuo7DvFnMxjCNJ6txg2JI8QXmTfMpccNCEuw6M//Z&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="General Object Inference" title="General Object Inference" src="/static/9e7ca505789722a51d11eeede2b2d3c3/c08c5/10.jpg" srcSet="/static/9e7ca505789722a51d11eeede2b2d3c3/0479a/10.jpg 250w,/static/9e7ca505789722a51d11eeede2b2d3c3/41099/10.jpg 500w,/static/9e7ca505789722a51d11eeede2b2d3c3/c08c5/10.jpg 640w" sizes="(max-width: 640px) 100vw, 640px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p><em>Image source: <a href="https://www.instagram.com/oleksii_trekhleb/?hl=en">oleksii_trekhleb</a> Instagram</em></p><p>To do that let&#x27;s save the image to the <code class="language-text">inference/test/</code> folder of our project. If you&#x27;re using Google Colab you may create this folder and upload the image manually.</p><p>Here is how the folder structure looks so far:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:602px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:61.6%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe3uUoP/xAAZEAACAwEAAAAAAAAAAAAAAAAQEQABAjH/2gAIAQEAAQUC5p0FEP/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABoQAQACAwEAAAAAAAAAAAAAAAEAEBEhYVH/2gAIAQEAAT8hV4M7U5O1mHlf/9oADAMBAAIAAwAAABAzz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABwQAQEAAgIDAAAAAAAAAAAAAAERACEQMVFhgf/aAAgBAQABPxBNXbTx1iBZ+bwaCk9YN0A0NQ1gaIBOP//Z&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Folder structure" title="Folder structure" src="/static/17fdcc432317dd5e59a939360936b0b0/e49d1/11.jpg" srcSet="/static/17fdcc432317dd5e59a939360936b0b0/0479a/11.jpg 250w,/static/17fdcc432317dd5e59a939360936b0b0/41099/11.jpg 500w,/static/17fdcc432317dd5e59a939360936b0b0/e49d1/11.jpg 602w" sizes="(max-width: 602px) 100vw, 602px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token operator">%</span>matplotlib inline

<span class="token comment"># Creating a TensorFlow dataset of just one image.</span>
inference_ds <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>preprocessing<span class="token punctuation">.</span>image_dataset_from_directory<span class="token punctuation">(</span>
  directory<span class="token operator">=</span><span class="token string">&#x27;inference&#x27;</span><span class="token punctuation">,</span>
  image_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">640</span><span class="token punctuation">,</span> <span class="token number">640</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  batch_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
  shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
  label_mode<span class="token operator">=</span><span class="token boolean">None</span>
<span class="token punctuation">)</span>
<span class="token comment"># Numpy version of the dataset.</span>
inference_ds_numpy <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>inference_ds<span class="token punctuation">.</span>as_numpy_iterator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># You may preview the images in dataset like this.</span>
plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> image <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>inference_ds_numpy<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">&quot;uint8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">&quot;off&quot;</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div><h3 id="running-the-detection-on-test-data" style="position:relative">Running the detection on test data<a href="#running-the-detection-on-test-data" aria-label="running the detection on test data permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>Now we&#x27;re ready to run the detection. The <code class="language-text">inference_ds_numpy[0]</code> array stores the pixel data for the first image in <code class="language-text">Numpy</code> format.</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">detections<span class="token punctuation">,</span> predictions_dict<span class="token punctuation">,</span> shapes <span class="token operator">=</span> inference_detect_fn<span class="token punctuation">(</span>
    inference_ds_numpy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre></div><p>Let&#x27;s see the shapes of the output:</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python">boxes <span class="token operator">=</span> detections<span class="token punctuation">[</span><span class="token string">&#x27;detection_boxes&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
scores <span class="token operator">=</span> detections<span class="token punctuation">[</span><span class="token string">&#x27;detection_scores&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
classes <span class="token operator">=</span> detections<span class="token punctuation">[</span><span class="token string">&#x27;detection_classes&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
num_detections <span class="token operator">=</span> detections<span class="token punctuation">[</span><span class="token string">&#x27;num_detections&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;boxes.shape: &#x27;</span><span class="token punctuation">,</span> boxes<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;scores.shape: &#x27;</span><span class="token punctuation">,</span> scores<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;classes.shape: &#x27;</span><span class="token punctuation">,</span> classes<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;num_detections:&#x27;</span><span class="token punctuation">,</span> num_detections<span class="token punctuation">)</span></code></pre></div><p><em>output →</em></p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">boxes.shape:  (1, 100, 4)
scores.shape:  (1, 100)
classes.shape:  (1, 100)
num_detections: 100.0</code></pre></div><p>The model has made a <code class="language-text">100</code> detections for us. It doesn&#x27;t mean that it found <code class="language-text">100</code> objects on the image though. It means that the model has <code class="language-text">100</code> slots, and it can detect <code class="language-text">100</code> objects at max on a single image. Each detection has a score that represents the confidence of the model about it. The bounding boxes for each detection are stored in the <code class="language-text">boxes</code> array. The scores or confidences of the model about each detection are stored in the <code class="language-text">scores</code> array. Finally, the <code class="language-text">classes</code> array stores the labels (classes) for each detection.</p><p>Let&#x27;s check the first 5 detections:</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;First 5 boxes:&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>boxes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;First 5 scores:&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>scores<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;First 5 classes:&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>classes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

class_names <span class="token operator">=</span> <span class="token punctuation">[</span>coco_category_index<span class="token punctuation">[</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#x27;name&#x27;</span><span class="token punctuation">]</span> <span class="token keyword">for</span> idx <span class="token keyword">in</span> classes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;First 5 class names:&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>class_names<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre></div><p><em>output →</em></p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">First 5 boxes:
[[0.17576033 0.84654826 0.25642633 0.88327974]
 [0.5187813  0.12410264 0.6344235  0.34545377]
 [0.5220358  0.5181462  0.6329132  0.7669856 ]
 [0.50933677 0.7045719  0.5619138  0.7446198 ]
 [0.44761637 0.51942706 0.61237675 0.75963426]]

First 5 scores:
[0.6950246 0.6343004 0.591157  0.5827219 0.5415643]

First 5 classes:
[9. 8. 8. 0. 8.]

First 5 class names:
[&#x27;traffic light&#x27;, &#x27;boat&#x27;, &#x27;boat&#x27;, &#x27;person&#x27;, &#x27;boat&#x27;]</code></pre></div><p>The model sees the <code class="language-text">traffic light</code>, three <code class="language-text">boats</code>, and a <code class="language-text">person</code> on the image. We may confirm that indeed these objects are seen on the image.</p><p>From the <code class="language-text">scores</code> array may see that the model is most confident (close to 70% of probability) in the <code class="language-text">traffic light</code> object.</p><p>Each entry of <code class="language-text">boxes</code> array is <code class="language-text">[y1, x1, y2, x2]</code>, where <code class="language-text">(x1, y1)</code> and <code class="language-text">(x2, y2)</code> are the top-left and bottom-right corners of the bounding box.</p><p>Let&#x27;s visualize the detection boxes:</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token comment"># Importing Object Detection API helpers.</span>
<span class="token keyword">from</span> object_detection<span class="token punctuation">.</span>utils <span class="token keyword">import</span> visualization_utils

<span class="token comment"># Visualizes the bounding boxes on top of the image.</span>
<span class="token keyword">def</span> <span class="token function">visualize_detections</span><span class="token punctuation">(</span>image_np<span class="token punctuation">,</span> detections<span class="token punctuation">,</span> category_index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    label_id_offset <span class="token operator">=</span> <span class="token number">1</span>
    image_np_with_detections <span class="token operator">=</span> image_np<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

    visualization_utils<span class="token punctuation">.</span>visualize_boxes_and_labels_on_image_array<span class="token punctuation">(</span>
        image_np_with_detections<span class="token punctuation">,</span>
        detections<span class="token punctuation">[</span><span class="token string">&#x27;detection_boxes&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>detections<span class="token punctuation">[</span><span class="token string">&#x27;detection_classes&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> label_id_offset<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        detections<span class="token punctuation">[</span><span class="token string">&#x27;detection_scores&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        category_index<span class="token punctuation">,</span>
        use_normalized_coordinates<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        max_boxes_to_draw<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>
        min_score_thresh<span class="token operator">=</span><span class="token number">.4</span><span class="token punctuation">,</span>
        agnostic_mode<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image_np_with_detections<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Visualizing the detections.</span>
visualize_detections<span class="token punctuation">(</span>
    image_np<span class="token operator">=</span>tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>inference_ds_numpy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>uint32<span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    detections<span class="token operator">=</span>detections<span class="token punctuation">,</span>
    category_index<span class="token operator">=</span>coco_category_index<span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre></div><p>Here is the output:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:709px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:99.2%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAECAwQF/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQID/9oADAMBAAIQAxAAAAGU3klrl6eISwnT/8QAHBAAAQQDAQAAAAAAAAAAAAAAAgABEhMRFCEz/9oACAEBAAEFAi9LCBbBohKyPX68GzDL0iv/xAAWEQADAAAAAAAAAAAAAAAAAAAAEBH/2gAIAQMBAT8BI//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAECAQE/ASP/xAAdEAACAQQDAAAAAAAAAAAAAAAAAQIRITFBECJR/9oACAEBAAY/Ap9mrlFNmh+VE1ZLPDMs2f/EABwQAQADAAIDAAAAAAAAAAAAAAEAESExQVGR4f/aAAgBAQABPyHfZnGwEKUcJM+PSYNLO44A7SURqN3brErdXjqX/U//2gAMAwEAAgADAAAAEHwA/P/EABYRAQEBAAAAAAAAAAAAAAAAABABMf/aAAgBAwEBPxATT//EABkRAQACAwAAAAAAAAAAAAAAAAABETFRYf/aAAgBAgEBPxDlU7Thb//EAB4QAQADAAICAwAAAAAAAAAAAAEAESExQVFhcZHR/9oACAEBAAE/ECjQiAELfFdZLp8aW98QYXdW7/YpyplHS/mCFCbLPrtj7DbOMj2Wqu+4ftOFyleqjqYf/9k=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Inference result" title="Inference result" src="/static/9312de3c7465a05f9ddd12eca3d9d385/bd958/12.jpg" srcSet="/static/9312de3c7465a05f9ddd12eca3d9d385/0479a/12.jpg 250w,/static/9312de3c7465a05f9ddd12eca3d9d385/41099/12.jpg 500w,/static/9312de3c7465a05f9ddd12eca3d9d385/bd958/12.jpg 709w" sizes="(max-width: 709px) 100vw, 709px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>If we will do the detection for the text image here is what we will see:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:709px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:99.2%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBP/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHujMikDqkNB//EABwQAAICAgMAAAAAAAAAAAAAAAABAhIDERAhMv/aAAgBAQABBQKTdts7JeuHjW6FD//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABcQAAMBAAAAAAAAAAAAAAAAAAABMRD/2gAIAQEABj8CevXSsrP/xAAcEAACAgIDAAAAAAAAAAAAAAAAAREhEHExYZH/2gAIAQEAAT8hobfJ2M3fpJ7y8MOmzGiCAf/aAAwDAQACAAMAAAAQLBDD/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAIBABAAICAQQDAAAAAAAAAAAAAQARIUFxYYGR0aGxwf/aAAgBAQABPxAgCLbY3v3sXfsRiYpcxzKGnHSN3n5lcZRwm3iKY856jd+56n//2Q==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Inference result for text image" title="Inference result for text image" src="/static/372fe51fcd25300ff07e0bba1d94b846/bd958/13.jpg" srcSet="/static/372fe51fcd25300ff07e0bba1d94b846/0479a/13.jpg 250w,/static/372fe51fcd25300ff07e0bba1d94b846/41099/13.jpg 500w,/static/372fe51fcd25300ff07e0bba1d94b846/bd958/13.jpg 709w" sizes="(max-width: 709px) 100vw, 709px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>The model couldn&#x27;t detect anything on this image. This is what we&#x27;re going to change, we want to teach the model to &quot;see&quot; the <code class="language-text">https://</code> prefixes on this image.</p><h2 id="-preparing-the-custom-dataset" style="position:relative">📝 Preparing the Custom Dataset<a href="#-preparing-the-custom-dataset" aria-label=" preparing the custom dataset permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>To &quot;teach&quot; the <code class="language-text">ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8</code> model to detect the custom objects which are <em>not</em> a part of a COCO dataset we need to do the fine-tune training on a new custom dataset.</p><p>The datasets for object detection consist of two parts:</p><ol><li>The image itself (i.e. the image of the book page)</li><li>The boundary boxes that show where exactly on the image the custom objects are located.</li></ol><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:52.400000000000006%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3VoB/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRAAAgMBAAAAAAAAAAAAAAAAAAERIFFh/9oACAEBAAE/IXpPRU//2gAMAwEAAgADAAAAEHDP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhABAAIDAQAAAAAAAAAAAAAAAQARECExcf/aAAgBAQABPxCw7NXyptVdRWdHyAQMf//Z&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Bounding Boxes" title="Bounding Boxes" src="/static/be25b47e961629a02f8ed3a656535b42/a2510/14.jpg" srcSet="/static/be25b47e961629a02f8ed3a656535b42/0479a/14.jpg 250w,/static/be25b47e961629a02f8ed3a656535b42/41099/14.jpg 500w,/static/be25b47e961629a02f8ed3a656535b42/a2510/14.jpg 1000w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>In the example above each box has <code class="language-text">left-top</code> and <code class="language-text">right-bottom</code> coordinates in <em>absolute</em> values (in pixels). However, there are also different formats of writing the location of the bounding boxes exists. For example, we may locate the bounding box by setting the coordinate of its <code class="language-text">center point</code> and its <code class="language-text">width</code> and <code class="language-text">height</code>. We might also use <em>relative</em> values (percentage of the width and height of the image) for setting up the coordinates. But you&#x27;ve got the idea, the network needs to know what the image is and where on the image the objects are located.</p><p>Now, how can we get the custom dataset for training? We have three options here:</p><ol><li><em>Re-use</em> the existing dataset.</li><li><em>Generate</em> a new dataset of fake book images.</li><li><em>Create</em> the dataset manually by taking or downloading the pictures of real book pages which contain <code class="language-text">https://</code> links and labeling all bounding boxes.</li></ol><h3 id="option-1-re-using-the-existing-dataset" style="position:relative">Option 1: Re-using the existing dataset<a href="#option-1-re-using-the-existing-dataset" aria-label="option 1 re using the existing dataset permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>There are plenty of the datasets that are shared to be re-used by researches. We could start from the following resources to find a proper dataset:</p><ul><li><a href="https://datasetsearch.research.google.com/">Google Dataset Search</a></li><li><a href="https://www.kaggle.com/datasets">Kaggle Datasets</a></li><li><a href="https://github.com/awesomedata/awesome-public-datasets">awesome-public-datasets</a> repository</li><li>etc.</li></ul><p>💚 If you could find the needed dataset and its license allows you to re-use it, it is probably the fastest way to get straight to the model training.</p><p>💔 I couldn&#x27;t find the dataset with labeled <code class="language-text">https://</code> prefixes though.</p><p>So we need to skip this option.</p><h3 id="option-2-generating-the-synthetic-dataset" style="position:relative">Option 2: Generating the synthetic dataset<a href="#option-2-generating-the-synthetic-dataset" aria-label="option 2 generating the synthetic dataset permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>There are tools that exist (i.e. <a href="https://keras-ocr.readthedocs.io/en/latest/examples/end_to_end_training.html#generating-synthetic-data">keras_ocr</a>) that might help us to generate random text, include the link in it, and draw it on images with some background and distortions.</p><p>💚 The cool part about this approach is that we have the freedom to generate training examples for different <em>fonts</em>, <em>ligatures</em>, <em>text colors</em>, <em>background colors</em>. This is very useful if we want to avoid the <a href="https://en.wikipedia.org/wiki/Overfitting">model overfitting</a> during the training (so that the model could generalize well to unseen real-world examples instead of failing once the background shade is changed for a bit).</p><p>💚 It is also possible to generate a variety of link types like <code class="language-text">http://</code>, <code class="language-text">http://</code>, <code class="language-text">ftp://</code>, <code class="language-text">tcp://</code> etc. Otherwise, it might be hard to find enough real-world examples of this kind of links for training.</p><p>💚 Another benefit of this approach is that we could generate as many training examples as we want. We&#x27;re not limited to the number of pages of the printed book we&#x27;ve found for the dataset. Increasing the number of training examples may also increase the accuracy of the model.</p><p>💔 It is possible though to misuse the generator and to generate the training images that will be quite different from real-world examples. Let&#x27;s say we may use the wrong and unrealistic distortions for the page (i.e. using waves bend instead of the arc one). In this case, the model will not generalize well to real-world examples.</p><blockquote><p>I see this approach as a really promising one. It may help to overcome many model issues (more on that below). I didn&#x27;t try it yet though. But it might be a good candidate for another article.</p></blockquote><h3 id="option-3-creating-the-dataset-manually" style="position:relative">Option 3: Creating the dataset manually<a href="#option-3-creating-the-dataset-manually" aria-label="option 3 creating the dataset manually permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>The most straightforward way though is to get the book (or books) and to make the pictures of the pages with the links and to label all of them manually.</p><p>The good news is that the dataset might be pretty small (hundreds of images might be enough) because we&#x27;re not going to train the model <em>from scratch</em> but instead, we&#x27;re going to do a <a href="https://en.wikipedia.org/wiki/Transfer_learning">transfer learning</a> (also see the <a href="https://paperswithcode.com/task/few-shot-learning">few-shot learning</a>.)</p><p>💚 In this case, the training dataset will be really close to real-world data. You will literally take the printed book, take a picture of it with realistic fonts, bends, shades, perspectives, and colors.</p><p>💔 Even though it doesn&#x27;t require a lot of images it may still be time-consuming.</p><p>💔 It is hard to come up with a diverse database where training examples would have different fonts, background colors, and different types of links (we need to find many diverse books and magazines to accomplish that).</p><p>Since the article has a learning purpose and since we&#x27;re not trying to win an object detection competition let&#x27;s go with this option for now and try to create a dataset by ourselves.</p><h3 id="preprocessing-the-data" style="position:relative">Preprocessing the data<a href="#preprocessing-the-data" aria-label="preprocessing the data permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>So, I&#x27;ve ended up shooting <code class="language-text">125</code> images of the book pages that contain one or more <code class="language-text">https://</code> links on them.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:60.4%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAddWgKD/xAAXEAADAQAAAAAAAAAAAAAAAAARIUEA/9oACAEBAAEFApKMEH//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAaEAADAQADAAAAAAAAAAAAAAAAATEhAjJB/9oACAEBAAY/Al29Jyg8ZWVwes//xAAcEAACAgIDAAAAAAAAAAAAAAAAATFREUEhgZH/2gAIAQEAAT8hSUANLKie6KFD2PmqbO4Wf//aAAwDAQACAAMAAAAQAA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAfEAABBAICAwAAAAAAAAAAAAABABEhMUFxUWGBkcH/2gAIAQEAAT8QMgg1jI38XgWgzdb5RA9jeDArpFAxh9nRCLDPa72i41jmoIC//9k=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Raw Dataset" title="Raw Dataset" src="/static/5ef08870a8d0193042c9da2c8aa8eb0c/a2510/15.jpg" srcSet="/static/5ef08870a8d0193042c9da2c8aa8eb0c/0479a/15.jpg 250w,/static/5ef08870a8d0193042c9da2c8aa8eb0c/41099/15.jpg 500w,/static/5ef08870a8d0193042c9da2c8aa8eb0c/a2510/15.jpg 1000w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>I put all these images in the <code class="language-text">dataset/printed_links/raw</code> folder.</p><p>Next, I&#x27;m going to preprocess the images by doing the following:</p><ul><li><strong>Resize</strong> each image to the width of <code class="language-text">1024px</code> (they are too big originally and have a width of <code class="language-text">3024px</code>)</li><li><strong>Crop</strong> each image to make them squared (this is optional, and we could just resize the image by simply squeezing it, but I want the model to be trained on realistic proportions of <code class="language-text">https:</code> boxes).</li><li><strong>Rotate</strong> image if needed by applying the <a href="https://en.wikipedia.org/wiki/Exif">exif</a> metadata.</li><li><strong>Greyscale</strong> the image (we don&#x27;t need the model to take the colors into consideration).</li><li><strong>Increase brightness</strong></li><li><strong>Increase contrast</strong></li><li><strong>Increase sharpness</strong></li></ul><p>Remember, that once we&#x27;ve decided to apply these transformations and adjustments to the dataset we need to do the same in the future for each image that we will send to the model for detection.</p><p>Here is how we could apply these adjustments to the image using Python:</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> math
<span class="token keyword">import</span> shutil

<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token punctuation">,</span> ImageOps<span class="token punctuation">,</span> ImageEnhance

<span class="token comment"># Resize an image.</span>
<span class="token keyword">def</span> <span class="token function">preprocess_resize</span><span class="token punctuation">(</span>target_width<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>image<span class="token punctuation">:</span> Image<span class="token punctuation">.</span>Image<span class="token punctuation">,</span> log<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Image<span class="token punctuation">.</span>Image<span class="token punctuation">:</span>
        <span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span> <span class="token operator">=</span> image<span class="token punctuation">.</span>size
        ratio <span class="token operator">=</span> width <span class="token operator">/</span> height

        <span class="token keyword">if</span> width <span class="token operator">&gt;</span> target_width<span class="token punctuation">:</span>
            target_height <span class="token operator">=</span> math<span class="token punctuation">.</span>floor<span class="token punctuation">(</span>target_width <span class="token operator">/</span> ratio<span class="token punctuation">)</span>
            log<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;Resizing: To size </span><span class="token interpolation"><span class="token punctuation">{</span>target_width<span class="token punctuation">}</span></span><span class="token string">x</span><span class="token interpolation"><span class="token punctuation">{</span>target_height<span class="token punctuation">}</span></span><span class="token string">&#x27;</span></span><span class="token punctuation">)</span>
            image <span class="token operator">=</span> image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span>target_width<span class="token punctuation">,</span> target_height<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            log<span class="token punctuation">(</span><span class="token string">&#x27;Resizing: Image already resized, skipping...&#x27;</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> image
    <span class="token keyword">return</span> preprocess

<span class="token comment"># Crop an image.</span>
<span class="token keyword">def</span> <span class="token function">preprocess_crop_square</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>image<span class="token punctuation">:</span> Image<span class="token punctuation">.</span>Image<span class="token punctuation">,</span> log<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Image<span class="token punctuation">.</span>Image<span class="token punctuation">:</span>
        <span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span> <span class="token operator">=</span> image<span class="token punctuation">.</span>size

        left <span class="token operator">=</span> <span class="token number">0</span>
        top <span class="token operator">=</span> <span class="token number">0</span>
        right <span class="token operator">=</span> width
        bottom <span class="token operator">=</span> height

        crop_size <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>

        <span class="token keyword">if</span> width <span class="token operator">&gt;=</span> height<span class="token punctuation">:</span>
            <span class="token comment"># Horizontal image.</span>
            log<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;Squre cropping: Horizontal </span><span class="token interpolation"><span class="token punctuation">{</span>crop_size<span class="token punctuation">}</span></span><span class="token string">x</span><span class="token interpolation"><span class="token punctuation">{</span>crop_size<span class="token punctuation">}</span></span><span class="token string">&#x27;</span></span><span class="token punctuation">)</span>
            left <span class="token operator">=</span> width <span class="token operator">//</span> <span class="token number">2</span> <span class="token operator">-</span> crop_size <span class="token operator">//</span> <span class="token number">2</span>
            right <span class="token operator">=</span> left <span class="token operator">+</span> crop_size
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># Vetyical image.</span>
            log<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;Squre cropping: Vertical </span><span class="token interpolation"><span class="token punctuation">{</span>crop_size<span class="token punctuation">}</span></span><span class="token string">x</span><span class="token interpolation"><span class="token punctuation">{</span>crop_size<span class="token punctuation">}</span></span><span class="token string">&#x27;</span></span><span class="token punctuation">)</span>
            top <span class="token operator">=</span> height <span class="token operator">//</span> <span class="token number">2</span> <span class="token operator">-</span> crop_size <span class="token operator">//</span> <span class="token number">2</span>
            bottom <span class="token operator">=</span> top <span class="token operator">+</span> crop_size

        image <span class="token operator">=</span> image<span class="token punctuation">.</span>crop<span class="token punctuation">(</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> image
    <span class="token keyword">return</span> preprocess

<span class="token comment"># Apply exif transpose to an image.</span>
<span class="token keyword">def</span> <span class="token function">preprocess_exif_transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># @see: https://pillow.readthedocs.io/en/stable/reference/ImageOps.html</span>
    <span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>image<span class="token punctuation">:</span> Image<span class="token punctuation">.</span>Image<span class="token punctuation">,</span> log<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Image<span class="token punctuation">.</span>Image<span class="token punctuation">:</span>
        log<span class="token punctuation">(</span><span class="token string">&#x27;EXif transpose&#x27;</span><span class="token punctuation">)</span>
        image <span class="token operator">=</span> ImageOps<span class="token punctuation">.</span>exif_transpose<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        <span class="token keyword">return</span> image
    <span class="token keyword">return</span> preprocess

<span class="token comment"># Apply color transformations to the image.</span>
<span class="token keyword">def</span> <span class="token function">preprocess_color</span><span class="token punctuation">(</span>brightness<span class="token punctuation">,</span> contrast<span class="token punctuation">,</span> color<span class="token punctuation">,</span> sharpness<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># @see: https://pillow.readthedocs.io/en/3.0.x/reference/ImageEnhance.html</span>
    <span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>image<span class="token punctuation">:</span> Image<span class="token punctuation">.</span>Image<span class="token punctuation">,</span> log<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Image<span class="token punctuation">.</span>Image<span class="token punctuation">:</span>
        log<span class="token punctuation">(</span><span class="token string">&#x27;Coloring&#x27;</span><span class="token punctuation">)</span>

        enhancer <span class="token operator">=</span> ImageEnhance<span class="token punctuation">.</span>Color<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        image <span class="token operator">=</span> enhancer<span class="token punctuation">.</span>enhance<span class="token punctuation">(</span>color<span class="token punctuation">)</span>

        enhancer <span class="token operator">=</span> ImageEnhance<span class="token punctuation">.</span>Brightness<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        image <span class="token operator">=</span> enhancer<span class="token punctuation">.</span>enhance<span class="token punctuation">(</span>brightness<span class="token punctuation">)</span>

        enhancer <span class="token operator">=</span> ImageEnhance<span class="token punctuation">.</span>Contrast<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        image <span class="token operator">=</span> enhancer<span class="token punctuation">.</span>enhance<span class="token punctuation">(</span>contrast<span class="token punctuation">)</span>

        enhancer <span class="token operator">=</span> ImageEnhance<span class="token punctuation">.</span>Sharpness<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        image <span class="token operator">=</span> enhancer<span class="token punctuation">.</span>enhance<span class="token punctuation">(</span>sharpness<span class="token punctuation">)</span>

        <span class="token keyword">return</span> image
    <span class="token keyword">return</span> preprocess

<span class="token comment"># Image pre-processing pipeline.</span>
<span class="token keyword">def</span> <span class="token function">preprocess_pipeline</span><span class="token punctuation">(</span>src_dir<span class="token punctuation">,</span> dest_dir<span class="token punctuation">,</span> preprocessors<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> files_num_limit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> override<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Create destination folder if not exists.</span>
    Path<span class="token punctuation">(</span>dest_dir<span class="token punctuation">)</span><span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># Get the list of files to be copied.</span>
    src_file_names <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>src_dir<span class="token punctuation">)</span>
    files_total <span class="token operator">=</span> files_num_limit <span class="token keyword">if</span> files_num_limit <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token builtin">len</span><span class="token punctuation">(</span>src_file_names<span class="token punctuation">)</span>
    files_processed <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token comment"># Logger function.</span>
    <span class="token keyword">def</span> <span class="token function">preprocessor_log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;  &#x27;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span>

    <span class="token comment"># Iterate through files.</span>
    <span class="token keyword">for</span> src_file_index<span class="token punctuation">,</span> src_file_name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>src_file_names<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> files_num_limit <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> src_file_index <span class="token operator">&gt;=</span> files_num_limit<span class="token punctuation">:</span>
            <span class="token keyword">break</span>

        <span class="token comment"># Copy file.</span>
        src_file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>src_dir<span class="token punctuation">,</span> src_file_name<span class="token punctuation">)</span>
        dest_file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dest_dir<span class="token punctuation">,</span> src_file_name<span class="token punctuation">)</span>

        progress <span class="token operator">=</span> math<span class="token punctuation">.</span>floor<span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> <span class="token punctuation">(</span>src_file_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> files_total<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;Image </span><span class="token interpolation"><span class="token punctuation">{</span>src_file_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>files_total<span class="token punctuation">}</span></span><span class="token string"> | </span><span class="token interpolation"><span class="token punctuation">{</span>progress<span class="token punctuation">}</span></span><span class="token string">% |  </span><span class="token interpolation"><span class="token punctuation">{</span>src_file_path<span class="token punctuation">}</span></span><span class="token string">&#x27;</span></span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>src_file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            preprocessor_log<span class="token punctuation">(</span><span class="token string">&#x27;Source is not a file, skipping...\n&#x27;</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> override <span class="token keyword">and</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>dest_file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            preprocessor_log<span class="token punctuation">(</span><span class="token string">&#x27;File already exists, skipping...\n&#x27;</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>

        shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>src_file_path<span class="token punctuation">,</span> dest_file_path<span class="token punctuation">)</span>
        files_processed <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token comment"># Preprocess file.</span>
        image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>dest_file_path<span class="token punctuation">)</span>

        <span class="token keyword">for</span> preprocessor <span class="token keyword">in</span> preprocessors<span class="token punctuation">:</span>
            image <span class="token operator">=</span> preprocessor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> preprocessor_log<span class="token punctuation">)</span>

        image<span class="token punctuation">.</span>save<span class="token punctuation">(</span>dest_file_path<span class="token punctuation">,</span> quality<span class="token operator">=</span><span class="token number">95</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;&#x27;</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;</span><span class="token interpolation"><span class="token punctuation">{</span>files_processed<span class="token punctuation">}</span></span><span class="token string"> out of </span><span class="token interpolation"><span class="token punctuation">{</span>files_total<span class="token punctuation">}</span></span><span class="token string"> files have been processed&#x27;</span></span><span class="token punctuation">)</span>

<span class="token comment"># Launching the image preprocessing pipeline.</span>
preprocess_pipeline<span class="token punctuation">(</span>
    src_dir<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/raw&#x27;</span><span class="token punctuation">,</span>
    dest_dir<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/processed&#x27;</span><span class="token punctuation">,</span>
    override<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    <span class="token comment"># files_num_limit=1,</span>
    preprocessors<span class="token operator">=</span><span class="token punctuation">[</span>
        preprocess_exif_transpose<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        preprocess_resize<span class="token punctuation">(</span>target_width<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        preprocess_crop_square<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        preprocess_color<span class="token punctuation">(</span>brightness<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> contrast<span class="token operator">=</span><span class="token number">1.3</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> sharpness<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre></div><p>As a result, all processed images were saved to the <code class="language-text">dataset/printed_links/processed</code> folder.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:52%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3KBR/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABPyFf/9oADAMBAAIAAwAAABCzD//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EAB0QAQABBQADAAAAAAAAAAAAAAEAESExQVFhscH/2gAIAQEAAT8QwY13zEPe4BVr3soUxr7EL27AKtp//9k=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Dataset Processed" title="Dataset Processed" src="/static/d573633530a534c4c87aeb4d0bc0f2d6/a2510/16.jpg" srcSet="/static/d573633530a534c4c87aeb4d0bc0f2d6/0479a/16.jpg 250w,/static/d573633530a534c4c87aeb4d0bc0f2d6/41099/16.jpg 500w,/static/d573633530a534c4c87aeb4d0bc0f2d6/a2510/16.jpg 1000w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>You may preview the images like this:</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">def</span> <span class="token function">preview_images</span><span class="token punctuation">(</span>images_dir<span class="token punctuation">,</span> images_num<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    image_names <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>images_dir<span class="token punctuation">)</span>
    image_names <span class="token operator">=</span> image_names<span class="token punctuation">[</span><span class="token punctuation">:</span>images_num<span class="token punctuation">]</span>

    num_cells <span class="token operator">=</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>images_num<span class="token punctuation">)</span><span class="token punctuation">)</span>
    figure <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span>figsize<span class="token punctuation">)</span>

    <span class="token keyword">for</span> image_index<span class="token punctuation">,</span> image_name <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>image_names<span class="token punctuation">)</span><span class="token punctuation">:</span>
        image_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>images_dir<span class="token punctuation">,</span> image_name<span class="token punctuation">)</span>
        image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>

        figure<span class="token punctuation">.</span>add_subplot<span class="token punctuation">(</span>num_cells<span class="token punctuation">,</span> num_cells<span class="token punctuation">,</span> image_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

preview_images<span class="token punctuation">(</span><span class="token string">&#x27;dataset/printed_links/processed&#x27;</span><span class="token punctuation">,</span> images_num<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div><h3 id="labeling-the-dataset" style="position:relative">Labeling the dataset<a href="#labeling-the-dataset" aria-label="labeling the dataset permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>To do the labeling (to mark the locations of the objects that we&#x27;re interested in, namely the <code class="language-text">https://</code> prefixes) we may use the <a href="https://github.com/tzutalin/labelImg">LabelImg</a> graphical image annotation tool.</p><blockquote><p>For this step you might want to install the LabelImg tool on your local machine (not in Colab). You may find the detailed installation instructions in <a href="https://github.com/tzutalin/labelImg">LabelImg README</a>.</p></blockquote><p>Once you have LabelImg tool installed you may launch it for the <code class="language-text">dataset/printed_links/processed</code> folder from the root of your project like this:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">labelImg dataset/printed_links/processed</code></pre></div><p>Then you&#x27;ll need to label all the images from the <code class="language-text">dataset/printed_links/processed</code> folder and save annotations as XML files to <code class="language-text">dataset/printed_links/labels/xml/</code> folder.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:49.199999999999996%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAde0hkB//8QAGBAAAgMAAAAAAAAAAAAAAAAAABABITH/2gAIAQEAAQUCVEYv/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhAAAwAAAAAAAAAAAAAAAAAAECAx/9oACAEBAAY/AhU//8QAGxAAAQQDAAAAAAAAAAAAAAAAAQARIDEhkfD/2gAIAQEAAT8hBpPixpctA//aAAwDAQACAAMAAAAQgw//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAADAQEBAQAAAAAAAAAAAAAAAREhkUFR/9oACAEBAAE/EMof29NQ1dQTj0UVuaMrP//Z&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Labeling" title="Labeling" src="/static/84c3f7d93cf84fce45d6093732c6ef01/a2510/17.jpg" srcSet="/static/84c3f7d93cf84fce45d6093732c6ef01/0479a/17.jpg 250w,/static/84c3f7d93cf84fce45d6093732c6ef01/41099/17.jpg 500w,/static/84c3f7d93cf84fce45d6093732c6ef01/a2510/17.jpg 1000w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p><img src="/posts-assets/1a60a56a4a04291057f8b04ae1d6aed2/18.gif" alt="Labeling Process"/></p><p>After the labeling we should have an XML file with bounding boxes data for each image:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:622px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:86.4%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB5hbnIFDIP//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEAAQUCH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABoQAQEAAwEBAAAAAAAAAAAAAAEAETFRECH/2gAIAQEAAT8hLDxsMP2V7Zjc68//2gAMAwEAAgADAAAAEIcfff/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EAB0QAQACAgIDAAAAAAAAAAAAAAEAESExEJFRYYH/2gAIAQEAAT8QClIxPKXyehiUy9ypt3LeWauT/9k=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Labels folder structure" title="Labels folder structure" src="/static/bfa1a524d91a647ee2ecfcd419d1be74/5e4ef/19.jpg" srcSet="/static/bfa1a524d91a647ee2ecfcd419d1be74/0479a/19.jpg 250w,/static/bfa1a524d91a647ee2ecfcd419d1be74/41099/19.jpg 500w,/static/bfa1a524d91a647ee2ecfcd419d1be74/5e4ef/19.jpg 622w" sizes="(max-width: 622px) 100vw, 622px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><h3 id="splitting-the-dataset-into-train-test-and-validation-subsets" style="position:relative">Splitting the dataset into train, test, and validation subsets<a href="#splitting-the-dataset-into-train-test-and-validation-subsets" aria-label="splitting the dataset into train test and validation subsets permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>To identify the model&#x27;s <a href="https://en.wikipedia.org/wiki/Overfitting">overfitting or underfitting</a> issue we need to split the dataset into <code class="language-text">train</code> and <code class="language-text">test</code> dataset. Let&#x27;s say <code class="language-text">80%</code> of our images will be used to train the model and <code class="language-text">20%</code> of the images will be used to check how well the model generalizes to the images that it didn&#x27;t see before.</p><blockquote><p>In this section we&#x27;ll do the files splitting by copying them into different folders (<code class="language-text">test</code> and <code class="language-text">train</code> folders). However, this might not be the most optimal way. Instead, the splitting of the dataset may be done on <a href="https://www.tensorflow.org/api_docs/python/tf/data/Dataset">tf.data.Dataset</a> level.</p></blockquote><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> re
<span class="token keyword">import</span> random

<span class="token keyword">def</span> <span class="token function">partition_dataset</span><span class="token punctuation">(</span>
    images_dir<span class="token punctuation">,</span>
    xml_labels_dir<span class="token punctuation">,</span>
    train_dir<span class="token punctuation">,</span>
    test_dir<span class="token punctuation">,</span>
    val_dir<span class="token punctuation">,</span>
    train_ratio<span class="token punctuation">,</span>
    test_ratio<span class="token punctuation">,</span>
    val_ratio<span class="token punctuation">,</span>
    copy_xml
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>train_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>train_dir<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>test_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>test_dir<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>val_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>val_dir<span class="token punctuation">)</span>

    images <span class="token operator">=</span> <span class="token punctuation">[</span>f <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>images_dir<span class="token punctuation">)</span>
              <span class="token keyword">if</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r&#x27;([a-zA-Z0-9\s_\\.\-\(\):])+(.jpg|.jpeg|.png)$&#x27;</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span><span class="token punctuation">]</span>

    num_images <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span>

    num_train_images <span class="token operator">=</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>train_ratio <span class="token operator">*</span> num_images<span class="token punctuation">)</span>
    num_test_images <span class="token operator">=</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>test_ratio <span class="token operator">*</span> num_images<span class="token punctuation">)</span>
    num_val_images <span class="token operator">=</span> math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>val_ratio <span class="token operator">*</span> num_images<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;Intended split&#x27;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;  train: </span><span class="token interpolation"><span class="token punctuation">{</span>num_train_images<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>num_images<span class="token punctuation">}</span></span><span class="token string"> images&#x27;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;  test: </span><span class="token interpolation"><span class="token punctuation">{</span>num_test_images<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>num_images<span class="token punctuation">}</span></span><span class="token string"> images&#x27;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;  val: </span><span class="token interpolation"><span class="token punctuation">{</span>num_val_images<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>num_images<span class="token punctuation">}</span></span><span class="token string"> images&#x27;</span></span><span class="token punctuation">)</span>

    actual_num_train_images <span class="token operator">=</span> <span class="token number">0</span>
    actual_num_test_images <span class="token operator">=</span> <span class="token number">0</span>
    actual_num_val_images <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">copy_random_images</span><span class="token punctuation">(</span>num_images<span class="token punctuation">,</span> dest_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
        copied_num <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> num_images<span class="token punctuation">:</span>
            <span class="token keyword">return</span> copied_num

        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_images<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span>

            idx <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            filename <span class="token operator">=</span> images<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
            shutil<span class="token punctuation">.</span>copyfile<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>images_dir<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dest_dir<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> copy_xml<span class="token punctuation">:</span>
                xml_filename <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">&#x27;.xml&#x27;</span>
                shutil<span class="token punctuation">.</span>copyfile<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>xml_labels_dir<span class="token punctuation">,</span> xml_filename<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dest_dir<span class="token punctuation">,</span> xml_filename<span class="token punctuation">)</span><span class="token punctuation">)</span>

            images<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>images<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span>
            copied_num <span class="token operator">+=</span> <span class="token number">1</span>

        <span class="token keyword">return</span> copied_num

    actual_num_train_images <span class="token operator">=</span> copy_random_images<span class="token punctuation">(</span>num_train_images<span class="token punctuation">,</span> train_dir<span class="token punctuation">)</span>
    actual_num_test_images <span class="token operator">=</span> copy_random_images<span class="token punctuation">(</span>num_test_images<span class="token punctuation">,</span> test_dir<span class="token punctuation">)</span>
    actual_num_val_images <span class="token operator">=</span> copy_random_images<span class="token punctuation">(</span>num_val_images<span class="token punctuation">,</span> val_dir<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;\n&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;Actual split&#x27;</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;  train: </span><span class="token interpolation"><span class="token punctuation">{</span>actual_num_train_images<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>num_images<span class="token punctuation">}</span></span><span class="token string"> images&#x27;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;  test: </span><span class="token interpolation"><span class="token punctuation">{</span>actual_num_test_images<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>num_images<span class="token punctuation">}</span></span><span class="token string"> images&#x27;</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;  val: </span><span class="token interpolation"><span class="token punctuation">{</span>actual_num_val_images<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>num_images<span class="token punctuation">}</span></span><span class="token string"> images&#x27;</span></span><span class="token punctuation">)</span>

partition_dataset<span class="token punctuation">(</span>
    images_dir<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/processed&#x27;</span><span class="token punctuation">,</span>
    train_dir<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/partitioned/train&#x27;</span><span class="token punctuation">,</span>
    test_dir<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/partitioned/test&#x27;</span><span class="token punctuation">,</span>
    val_dir<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/partitioned/val&#x27;</span><span class="token punctuation">,</span>
    xml_labels_dir<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/labels/xml&#x27;</span><span class="token punctuation">,</span>
    train_ratio<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span>
    test_ratio<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span>
    val_ratio<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    copy_xml<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span></code></pre></div><p>After splitting your dataset folder structure should look similar to this:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">dataset/
└── printed_links
    ├── labels
    │   └── xml
    ├── partitioned
    │   ├── test
    │   └── train
    │       ├── IMG_9140.JPG
    │       ├── IMG_9140.xml
    │       ├── IMG_9141.JPG
    │       ├── IMG_9141.xml
    │       ...
    ├── processed
    └── raw</code></pre></div><h3 id="exporting-the-dataset" style="position:relative">Exporting the dataset<a href="#exporting-the-dataset" aria-label="exporting the dataset permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>The last manipulation we should do with the data is to convert our datasets into <a href="https://www.tensorflow.org/tutorials/load_data/tfrecord">TFRecord</a> format. The <code class="language-text">TFRecord</code> format is a format that TensorFlow is using for storing a sequence of binary records.</p><p>First, let&#x27;s create two folders: one is for the labels in <code class="language-text">CSV</code> format, and the other one is for the final dataset in <code class="language-text">TFRecord</code> format.</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p dataset/printed_links/labels/csv
<span class="token function">mkdir</span> -p dataset/printed_links/tfrecords</code></pre></div><p>Now we need to create a <code class="language-text">dataset/printed_links/labels/label_map.pbtxt</code> proto file that will describe the classes of the objects in our dataset. In our case, we only have <em>one class</em> which we may call <code class="language-text">http</code>. Here is the content of this file:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">item {
  id: 1
  name: &#x27;http&#x27;
}</code></pre></div><p>Now we&#x27;re ready to generate the TFRecord datasets out of images in <code class="language-text">jpg</code> format and labels in <code class="language-text">xml</code> format:</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> io
<span class="token keyword">import</span> math
<span class="token keyword">import</span> glob
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> xml<span class="token punctuation">.</span>etree<span class="token punctuation">.</span>ElementTree <span class="token keyword">as</span> ET
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple
<span class="token keyword">from</span> object_detection<span class="token punctuation">.</span>utils <span class="token keyword">import</span> dataset_util<span class="token punctuation">,</span> label_map_util

tf1 <span class="token operator">=</span> tf<span class="token punctuation">.</span>compat<span class="token punctuation">.</span>v1

<span class="token comment"># Convers labels from XML format to CSV.</span>
<span class="token keyword">def</span> <span class="token function">xml_to_csv</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    xml_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> xml_file <span class="token keyword">in</span> glob<span class="token punctuation">.</span>glob<span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token string">&#x27;/*.xml&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        tree <span class="token operator">=</span> ET<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>xml_file<span class="token punctuation">)</span>
        root <span class="token operator">=</span> tree<span class="token punctuation">.</span>getroot<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> member <span class="token keyword">in</span> root<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">&#x27;object&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            value <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">&#x27;filename&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">,</span>
                <span class="token builtin">int</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">&#x27;size&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token builtin">int</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">&#x27;size&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
                member<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">,</span>
                <span class="token builtin">int</span><span class="token punctuation">(</span>member<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token builtin">int</span><span class="token punctuation">(</span>member<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token builtin">int</span><span class="token punctuation">(</span>member<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token builtin">int</span><span class="token punctuation">(</span>member<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            xml_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    column_name <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#x27;filename&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;width&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;height&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;class&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;xmin&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;ymin&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;xmax&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;ymax&#x27;</span><span class="token punctuation">]</span>
    xml_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>xml_list<span class="token punctuation">,</span> columns<span class="token operator">=</span>column_name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> xml_df


<span class="token keyword">def</span> <span class="token function">class_text_to_int</span><span class="token punctuation">(</span>row_label<span class="token punctuation">,</span> label_map_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> label_map_dict<span class="token punctuation">[</span>row_label<span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">split</span><span class="token punctuation">(</span>df<span class="token punctuation">,</span> group<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">&#x27;data&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#x27;filename&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;object&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    gb <span class="token operator">=</span> df<span class="token punctuation">.</span>groupby<span class="token punctuation">(</span>group<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>data<span class="token punctuation">(</span>filename<span class="token punctuation">,</span> gb<span class="token punctuation">.</span>get_group<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> filename<span class="token punctuation">,</span> x <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>gb<span class="token punctuation">.</span>groups<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gb<span class="token punctuation">.</span>groups<span class="token punctuation">)</span><span class="token punctuation">]</span>


<span class="token comment"># Creates a TFRecord.</span>
<span class="token keyword">def</span> <span class="token function">create_tf_example</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> path<span class="token punctuation">,</span> label_map_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> tf1<span class="token punctuation">.</span>gfile<span class="token punctuation">.</span>GFile<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&#x27;{}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>group<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&#x27;rb&#x27;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fid<span class="token punctuation">:</span>
        encoded_jpg <span class="token operator">=</span> fid<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>

    encoded_jpg_io <span class="token operator">=</span> io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>encoded_jpg<span class="token punctuation">)</span>
    image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>encoded_jpg_io<span class="token punctuation">)</span>
    width<span class="token punctuation">,</span> height <span class="token operator">=</span> image<span class="token punctuation">.</span>size

    filename <span class="token operator">=</span> group<span class="token punctuation">.</span>filename<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">)</span>
    image_format <span class="token operator">=</span> <span class="token string">b&#x27;jpg&#x27;</span>
    xmins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    xmaxs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    ymins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    ymaxs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    classes_text <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> index<span class="token punctuation">,</span> row <span class="token keyword">in</span> group<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>iterrows<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        xmins<span class="token punctuation">.</span>append<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">&#x27;xmin&#x27;</span><span class="token punctuation">]</span> <span class="token operator">/</span> width<span class="token punctuation">)</span>
        xmaxs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">&#x27;xmax&#x27;</span><span class="token punctuation">]</span> <span class="token operator">/</span> width<span class="token punctuation">)</span>
        ymins<span class="token punctuation">.</span>append<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">&#x27;ymin&#x27;</span><span class="token punctuation">]</span> <span class="token operator">/</span> height<span class="token punctuation">)</span>
        ymaxs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">&#x27;ymax&#x27;</span><span class="token punctuation">]</span> <span class="token operator">/</span> height<span class="token punctuation">)</span>
        classes_text<span class="token punctuation">.</span>append<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">&#x27;class&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&#x27;utf8&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        classes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>class_text_to_int<span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token string">&#x27;class&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label_map_dict<span class="token punctuation">)</span><span class="token punctuation">)</span>

    tf_example <span class="token operator">=</span> tf1<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Example<span class="token punctuation">(</span>features<span class="token operator">=</span>tf1<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Features<span class="token punctuation">(</span>feature<span class="token operator">=</span><span class="token punctuation">{</span>
        <span class="token string">&#x27;image/height&#x27;</span><span class="token punctuation">:</span> dataset_util<span class="token punctuation">.</span>int64_feature<span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;image/width&#x27;</span><span class="token punctuation">:</span> dataset_util<span class="token punctuation">.</span>int64_feature<span class="token punctuation">(</span>width<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;image/filename&#x27;</span><span class="token punctuation">:</span> dataset_util<span class="token punctuation">.</span>bytes_feature<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;image/source_id&#x27;</span><span class="token punctuation">:</span> dataset_util<span class="token punctuation">.</span>bytes_feature<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;image/encoded&#x27;</span><span class="token punctuation">:</span> dataset_util<span class="token punctuation">.</span>bytes_feature<span class="token punctuation">(</span>encoded_jpg<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;image/format&#x27;</span><span class="token punctuation">:</span> dataset_util<span class="token punctuation">.</span>bytes_feature<span class="token punctuation">(</span>image_format<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;image/object/bbox/xmin&#x27;</span><span class="token punctuation">:</span> dataset_util<span class="token punctuation">.</span>float_list_feature<span class="token punctuation">(</span>xmins<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;image/object/bbox/xmax&#x27;</span><span class="token punctuation">:</span> dataset_util<span class="token punctuation">.</span>float_list_feature<span class="token punctuation">(</span>xmaxs<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;image/object/bbox/ymin&#x27;</span><span class="token punctuation">:</span> dataset_util<span class="token punctuation">.</span>float_list_feature<span class="token punctuation">(</span>ymins<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;image/object/bbox/ymax&#x27;</span><span class="token punctuation">:</span> dataset_util<span class="token punctuation">.</span>float_list_feature<span class="token punctuation">(</span>ymaxs<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;image/object/class/text&#x27;</span><span class="token punctuation">:</span> dataset_util<span class="token punctuation">.</span>bytes_list_feature<span class="token punctuation">(</span>classes_text<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;image/object/class/label&#x27;</span><span class="token punctuation">:</span> dataset_util<span class="token punctuation">.</span>int64_list_feature<span class="token punctuation">(</span>classes<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> tf_example


<span class="token keyword">def</span> <span class="token function">dataset_to_tfrecord</span><span class="token punctuation">(</span>
    images_dir<span class="token punctuation">,</span>
    xmls_dir<span class="token punctuation">,</span>
    label_map_path<span class="token punctuation">,</span>
    output_path<span class="token punctuation">,</span>
    csv_path<span class="token operator">=</span><span class="token boolean">None</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    label_map <span class="token operator">=</span> label_map_util<span class="token punctuation">.</span>load_labelmap<span class="token punctuation">(</span>label_map_path<span class="token punctuation">)</span>
    label_map_dict <span class="token operator">=</span> label_map_util<span class="token punctuation">.</span>get_label_map_dict<span class="token punctuation">(</span>label_map<span class="token punctuation">)</span>

    tfrecord_writer <span class="token operator">=</span> tf1<span class="token punctuation">.</span>python_io<span class="token punctuation">.</span>TFRecordWriter<span class="token punctuation">(</span>output_path<span class="token punctuation">)</span>
    images_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>images_dir<span class="token punctuation">)</span>
    csv_examples <span class="token operator">=</span> xml_to_csv<span class="token punctuation">(</span>xmls_dir<span class="token punctuation">)</span>
    grouped_examples <span class="token operator">=</span> split<span class="token punctuation">(</span>csv_examples<span class="token punctuation">,</span> <span class="token string">&#x27;filename&#x27;</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> group <span class="token keyword">in</span> grouped_examples<span class="token punctuation">:</span>
        tf_example <span class="token operator">=</span> create_tf_example<span class="token punctuation">(</span>group<span class="token punctuation">,</span> images_path<span class="token punctuation">,</span> label_map_dict<span class="token punctuation">)</span>
        tfrecord_writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span>tf_example<span class="token punctuation">.</span>SerializeToString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    tfrecord_writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;Successfully created the TFRecord file: {}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>output_path<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> csv_path <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        csv_examples<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span>csv_path<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;Successfully created the CSV file: {}&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>csv_path<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># Generate a TFRecord for train dataset.</span>
dataset_to_tfrecord<span class="token punctuation">(</span>
    images_dir<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/partitioned/train&#x27;</span><span class="token punctuation">,</span>
    xmls_dir<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/partitioned/train&#x27;</span><span class="token punctuation">,</span>
    label_map_path<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/labels/label_map.pbtxt&#x27;</span><span class="token punctuation">,</span>
    output_path<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/tfrecords/train.record&#x27;</span><span class="token punctuation">,</span>
    csv_path<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/labels/csv/train.csv&#x27;</span>
<span class="token punctuation">)</span>

<span class="token comment"># Generate a TFRecord for test dataset.</span>
dataset_to_tfrecord<span class="token punctuation">(</span>
    images_dir<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/partitioned/test&#x27;</span><span class="token punctuation">,</span>
    xmls_dir<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/partitioned/test&#x27;</span><span class="token punctuation">,</span>
    label_map_path<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/labels/label_map.pbtxt&#x27;</span><span class="token punctuation">,</span>
    output_path<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/tfrecords/test.record&#x27;</span><span class="token punctuation">,</span>
    csv_path<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/labels/csv/test.csv&#x27;</span>
<span class="token punctuation">)</span></code></pre></div><p>As a result we should now have two files: <code class="language-text">test.record</code> and <code class="language-text">train.record</code> in <code class="language-text">dataset/printed_links/tfrecords/</code> folder:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">dataset/
└── printed_links
    ├── labels
    │   ├── csv
    │   ├── label_map.pbtxt
    │   └── xml
    ├── partitioned
    │   ├── test
    │   ├── train
    │   └── val
    ├── processed
    ├── raw
    └── tfrecords
        ├── test.record
        └── train.record</code></pre></div><p>These two files <code class="language-text">test.record</code> and <code class="language-text">train.record</code> are our final datasets that we will use to fine-tune the <code class="language-text">ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8</code> model.</p><h2 id="-exploring-the-tfrecord-datasets" style="position:relative">📖 Exploring the TFRecord Datasets<a href="#-exploring-the-tfrecord-datasets" aria-label=" exploring the tfrecord datasets permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>In this section, we will see how we may use the TensorFlow 2 Object Detection API to explore the datasets in <code class="language-text">TFRecord</code> format.</p><p><strong>Checking the number of items in a dataset</strong></p><p>To count the number of items in the dataset we may do the following:</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

<span class="token comment"># Count the number of examples in the dataset.</span>
<span class="token keyword">def</span> <span class="token function">count_tfrecords</span><span class="token punctuation">(</span>tfrecords_filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    raw_dataset <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>TFRecordDataset<span class="token punctuation">(</span>tfrecords_filename<span class="token punctuation">)</span>
    <span class="token comment"># Keep in mind that the list() operation might be</span>
    <span class="token comment"># a performance bottleneck for large datasets.</span>
    <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>raw_dataset<span class="token punctuation">)</span><span class="token punctuation">)</span>

TRAIN_RECORDS_NUM <span class="token operator">=</span> count_tfrecords<span class="token punctuation">(</span><span class="token string">&#x27;dataset/printed_links/tfrecords/train.record&#x27;</span><span class="token punctuation">)</span>
TEST_RECORDS_NUM <span class="token operator">=</span> count_tfrecords<span class="token punctuation">(</span><span class="token string">&#x27;dataset/printed_links/tfrecords/test.record&#x27;</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;TRAIN_RECORDS_NUM: &#x27;</span><span class="token punctuation">,</span> TRAIN_RECORDS_NUM<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;TEST_RECORDS_NUM:  &#x27;</span><span class="token punctuation">,</span> TEST_RECORDS_NUM<span class="token punctuation">)</span></code></pre></div><p><em>output →</em></p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">TRAIN_RECORDS_NUM:  100
TEST_RECORDS_NUM:   25</code></pre></div><p>So we will train the model on <code class="language-text">100</code> examples, and we will check the model accuracy on <code class="language-text">25</code> test images.</p><p><strong>Previewing the dataset images with bounding boxes</strong></p><p>To preview images with detection boxes we may do the following:</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> google<span class="token punctuation">.</span>protobuf <span class="token keyword">import</span> text_format
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token comment"># Import Object Detection API.</span>
<span class="token keyword">from</span> object_detection<span class="token punctuation">.</span>utils <span class="token keyword">import</span> visualization_utils
<span class="token keyword">from</span> object_detection<span class="token punctuation">.</span>protos <span class="token keyword">import</span> string_int_label_map_pb2
<span class="token keyword">from</span> object_detection<span class="token punctuation">.</span>data_decoders<span class="token punctuation">.</span>tf_example_decoder <span class="token keyword">import</span> TfExampleDecoder

<span class="token operator">%</span>matplotlib inline

<span class="token comment"># Visualize the TFRecord dataset.</span>
<span class="token keyword">def</span> <span class="token function">visualize_tfrecords</span><span class="token punctuation">(</span>tfrecords_filename<span class="token punctuation">,</span> label_map<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> print_num<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    decoder <span class="token operator">=</span> TfExampleDecoder<span class="token punctuation">(</span>
        label_map_proto_file<span class="token operator">=</span>label_map<span class="token punctuation">,</span>
        use_display_name<span class="token operator">=</span><span class="token boolean">False</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">if</span> label_map <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        label_map_proto <span class="token operator">=</span> string_int_label_map_pb2<span class="token punctuation">.</span>StringIntLabelMap<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">with</span> tf<span class="token punctuation">.</span>io<span class="token punctuation">.</span>gfile<span class="token punctuation">.</span>GFile<span class="token punctuation">(</span>label_map<span class="token punctuation">,</span><span class="token string">&#x27;r&#x27;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            text_format<span class="token punctuation">.</span>Merge<span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> label_map_proto<span class="token punctuation">)</span>
            class_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

            <span class="token keyword">for</span> entry <span class="token keyword">in</span> label_map_proto<span class="token punctuation">.</span>item<span class="token punctuation">:</span>
                class_dict<span class="token punctuation">[</span>entry<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#x27;name&#x27;</span><span class="token punctuation">:</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">}</span>

    raw_dataset <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>TFRecordDataset<span class="token punctuation">(</span>tfrecords_filename<span class="token punctuation">)</span>

    <span class="token keyword">for</span> raw_record <span class="token keyword">in</span> raw_dataset<span class="token punctuation">.</span>take<span class="token punctuation">(</span>print_num<span class="token punctuation">)</span><span class="token punctuation">:</span>
        example <span class="token operator">=</span> decoder<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>raw_record<span class="token punctuation">)</span>

        image <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">&#x27;image&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        boxes <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">&#x27;groundtruth_boxes&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        confidences <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">&#x27;groundtruth_image_confidences&#x27;</span><span class="token punctuation">]</span>
        filename <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">&#x27;filename&#x27;</span><span class="token punctuation">]</span>
        area <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">&#x27;groundtruth_area&#x27;</span><span class="token punctuation">]</span>
        classes <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">&#x27;groundtruth_classes&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
        image_classes <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">&#x27;groundtruth_image_classes&#x27;</span><span class="token punctuation">]</span>
        weights <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">&#x27;groundtruth_weights&#x27;</span><span class="token punctuation">]</span>

        scores <span class="token operator">=</span> np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>boxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        visualization_utils<span class="token punctuation">.</span>visualize_boxes_and_labels_on_image_array<span class="token punctuation">(</span>
            image<span class="token punctuation">,</span>
            boxes<span class="token punctuation">,</span>
            classes<span class="token punctuation">,</span>
            scores<span class="token punctuation">,</span>
            class_dict<span class="token punctuation">,</span>
            max_boxes_to_draw<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
            use_normalized_coordinates<span class="token operator">=</span><span class="token boolean">True</span>
        <span class="token punctuation">)</span>

        plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Visualizing the training TFRecord dataset.</span>
visualize_tfrecords<span class="token punctuation">(</span>
    tfrecords_filename<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/tfrecords/train.record&#x27;</span><span class="token punctuation">,</span>
    label_map<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/labels/label_map.pbtxt&#x27;</span><span class="token punctuation">,</span>
    print_num<span class="token operator">=</span><span class="token number">3</span>
<span class="token punctuation">)</span></code></pre></div><p>As a result, we should see several images with bounding boxes drawn on top of each image.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:962px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:98%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQADAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHvtdCBiAH/xAAaEAACAgMAAAAAAAAAAAAAAAAAAQIQESEx/9oACAEBAAEFAqRwyRtaP//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABcQAAMBAAAAAAAAAAAAAAAAAAEQcSD/2gAIAQEABj8CRrNx/8QAHBAAAwACAwEAAAAAAAAAAAAAAAERMVEQIXGB/9oACAEBAAE/IVxmFnZ5HpSwa6+GdLZ//9oADAMBAAIAAwAAABBzDwD/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/EB//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/EB//xAAeEAEAAgEEAwAAAAAAAAAAAAABABEhMUFxsVFhkf/aAAgBAQABPxACaEo8R36V0Rq1qVzzLVdvksPTLoiUFd4OVu6DdBtngn//2Q==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="TFRecord Preview" title="TFRecord Preview" src="/static/ae63de06652048e7989d778b786dfec0/82d6d/20.jpg" srcSet="/static/ae63de06652048e7989d778b786dfec0/0479a/20.jpg 250w,/static/ae63de06652048e7989d778b786dfec0/41099/20.jpg 500w,/static/ae63de06652048e7989d778b786dfec0/82d6d/20.jpg 962w" sizes="(max-width: 962px) 100vw, 962px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><h2 id="-setting-up-tensorboard" style="position:relative">📈 Setting Up TensorBoard<a href="#-setting-up-tensorboard" aria-label=" setting up tensorboard permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>Before starting the training process we need to launch a <a href="https://www.tensorflow.org/tensorboard">TensorBoard</a>.</p><p>TensorBoard will allow us to monitor the training process and see if the model is actually learning something or should we better stop the training and adjust training parameters. It will also help us to analyze what objects and at what location the model is detecting.</p><p><img src="/posts-assets/d5ee9f7aee1b94550125340243d5ccf5/21.gif" alt="TensorBoard"/></p><p><em>Image source: <a href="https://www.tensorflow.org/tensorboard">TensorBoard homepage</a></em></p><p>The cool part about TensorBoard is that we may run it directly in Google Colab. However, if you&#x27;re running the notebook in your local installation of Jupyter you may also <a href="https://github.com/tensorflow/tensorboard/blob/master/README.md">install it as Python package</a> and launch it from the terminal.</p><p>First, let&#x27;s create a <code class="language-text">./logs</code> folder where all training logs will be written:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p logs</code></pre></div><p>Next, we may load the TensorBoard extension on Google Colab:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">%load_ext tensorboard</code></pre></div><p>And finally we may launch a TensorBoard to monitor the <code class="language-text">./logs</code> folder:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">%tensorboard --logdir ./logs</code></pre></div><p>As a result, you should see the empty TensorBoard panel:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:54.400000000000006%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAEDAgX/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAeyqPNyUD//EABgQAAMBAQAAAAAAAAAAAAAAAAABEgIQ/9oACAEBAAEFAnkkgff/xAAXEQADAQAAAAAAAAAAAAAAAAAAARES/9oACAEDAQE/AdMrP//EABcRAAMBAAAAAAAAAAAAAAAAAAABERL/2gAIAQIBAT8ByiI//8QAGRAAAgMBAAAAAAAAAAAAAAAAAZEAIDEy/9oACAEBAAY/AtLnRc0un//EABkQAQEBAAMAAAAAAAAAAAAAAAEAERAhQf/aAAgBAQABPyE92QWYC3mDrj//2gAMAwEAAgADAAAAEPzv/8QAFREBAQAAAAAAAAAAAAAAAAAAAGH/2gAIAQMBAT8Qos//xAAVEQEBAAAAAAAAAAAAAAAAAAAAYf/aAAgBAgEBPxCCT//EABwQAQACAgMBAAAAAAAAAAAAAAEAESExEFFxwf/aAAgBAQABPxA+Gt0ICNfVANvqmWXcJs3fvH//2Q==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Empty TensorBoard Panel" title="Empty TensorBoard Panel" src="/static/95e5581c409416c73ade13bd383b8274/a2510/22.jpg" srcSet="/static/95e5581c409416c73ade13bd383b8274/0479a/22.jpg 250w,/static/95e5581c409416c73ade13bd383b8274/41099/22.jpg 500w,/static/95e5581c409416c73ade13bd383b8274/a2510/22.jpg 1000w,/static/95e5581c409416c73ade13bd383b8274/c58a3/22.jpg 1500w,/static/95e5581c409416c73ade13bd383b8274/5ed7a/22.jpg 1832w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>After the model training is be started you may get back to this panel and see the training process progress.</p><h2 id="️-model-training" style="position:relative">🏋🏻‍️ Model Training<a href="#%EF%B8%8F-model-training" aria-label="️ model training permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><h3 id="configuring-the-detection-pipeline" style="position:relative">Configuring the Detection Pipeline<a href="#configuring-the-detection-pipeline" aria-label="configuring the detection pipeline permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>Now it&#x27;s time to get back to the <code class="language-text">cache/datasets/ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8/pipeline.config</code> file that we&#x27;ve mentioned earlier. This file defines the parameters of <code class="language-text">ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8</code> model training.</p><p>We need to copy the <code class="language-text">pipeline.config</code> file to the root of the project and adjust a couple of things in it:</p><ol><li>We should change the <strong>number of classes</strong> from <code class="language-text">90</code> (the COCO classes) to just <code class="language-text">1</code> (the <code class="language-text">http</code> class).</li><li>We should reduce the <strong>batch size</strong> to <code class="language-text">8</code> to avoid the errors that are connected to the insufficient memory.</li><li>We need to point the model to its <strong>checkpoints</strong> since we don&#x27;t want to train the model from scratch.</li><li>We need to change the <code class="language-text">fine_tune_checkpoint_type</code> to <code class="language-text">detection</code>.</li><li>We need to point the model to a proper <strong>labels map</strong>.</li><li>Lastly, we need to pint the model to the <strong>train and test datasets</strong>.</li></ol><p>All these changes may be done manually directly in <code class="language-text">pipeline.config</code> file. But we may also do them through code:</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">from</span> shutil <span class="token keyword">import</span> copyfile
<span class="token keyword">from</span> google<span class="token punctuation">.</span>protobuf <span class="token keyword">import</span> text_format
<span class="token keyword">from</span> object_detection<span class="token punctuation">.</span>protos <span class="token keyword">import</span> pipeline_pb2

<span class="token comment"># Adjust pipeline config modification here if needed.</span>
<span class="token keyword">def</span> <span class="token function">modify_config</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Model config.</span>
    pipeline<span class="token punctuation">.</span>model<span class="token punctuation">.</span>ssd<span class="token punctuation">.</span>num_classes <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token comment"># Train config.</span>
    pipeline<span class="token punctuation">.</span>train_config<span class="token punctuation">.</span>batch_size <span class="token operator">=</span> <span class="token number">8</span>

    pipeline<span class="token punctuation">.</span>train_config<span class="token punctuation">.</span>fine_tune_checkpoint <span class="token operator">=</span> <span class="token string">&#x27;cache/datasets/ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8/checkpoint/ckpt-0&#x27;</span>
    pipeline<span class="token punctuation">.</span>train_config<span class="token punctuation">.</span>fine_tune_checkpoint_type <span class="token operator">=</span> <span class="token string">&#x27;detection&#x27;</span>

    <span class="token comment"># Train input reader config.</span>
    pipeline<span class="token punctuation">.</span>train_input_reader<span class="token punctuation">.</span>label_map_path <span class="token operator">=</span> <span class="token string">&#x27;dataset/printed_links/labels/label_map.pbtxt&#x27;</span>
    pipeline<span class="token punctuation">.</span>train_input_reader<span class="token punctuation">.</span>tf_record_input_reader<span class="token punctuation">.</span>input_path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#x27;dataset/printed_links/tfrecords/train.record&#x27;</span>

    <span class="token comment"># Eval input reader config.</span>
    pipeline<span class="token punctuation">.</span>eval_input_reader<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>label_map_path <span class="token operator">=</span> <span class="token string">&#x27;dataset/printed_links/labels/label_map.pbtxt&#x27;</span>
    pipeline<span class="token punctuation">.</span>eval_input_reader<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tf_record_input_reader<span class="token punctuation">.</span>input_path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#x27;dataset/printed_links/tfrecords/test.record&#x27;</span>

    <span class="token keyword">return</span> pipeline

<span class="token keyword">def</span> <span class="token function">clone_pipeline_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    copyfile<span class="token punctuation">(</span>
        <span class="token string">&#x27;cache/datasets/ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8/pipeline.config&#x27;</span><span class="token punctuation">,</span>
        <span class="token string">&#x27;pipeline.config&#x27;</span>
    <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">setup_pipeline</span><span class="token punctuation">(</span>pipeline_config_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    clone_pipeline_config<span class="token punctuation">(</span><span class="token punctuation">)</span>
    pipeline <span class="token operator">=</span> read_pipeline_config<span class="token punctuation">(</span>pipeline_config_path<span class="token punctuation">)</span>
    pipeline <span class="token operator">=</span> modify_config<span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span>
    write_pipeline_config<span class="token punctuation">(</span>pipeline_config_path<span class="token punctuation">,</span> pipeline<span class="token punctuation">)</span>
    <span class="token keyword">return</span> pipeline

<span class="token keyword">def</span> <span class="token function">read_pipeline_config</span><span class="token punctuation">(</span>pipeline_config_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pipeline <span class="token operator">=</span> pipeline_pb2<span class="token punctuation">.</span>TrainEvalPipelineConfig<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>io<span class="token punctuation">.</span>gfile<span class="token punctuation">.</span>GFile<span class="token punctuation">(</span>pipeline_config_path<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        proto_str <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        text_format<span class="token punctuation">.</span>Merge<span class="token punctuation">(</span>proto_str<span class="token punctuation">,</span> pipeline<span class="token punctuation">)</span>
    <span class="token keyword">return</span> pipeline

<span class="token keyword">def</span> <span class="token function">write_pipeline_config</span><span class="token punctuation">(</span>pipeline_config_path<span class="token punctuation">,</span> pipeline<span class="token punctuation">)</span><span class="token punctuation">:</span>
    config_text <span class="token operator">=</span> text_format<span class="token punctuation">.</span>MessageToString<span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>io<span class="token punctuation">.</span>gfile<span class="token punctuation">.</span>GFile<span class="token punctuation">(</span>pipeline_config_path<span class="token punctuation">,</span> <span class="token string">&quot;wb&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>config_text<span class="token punctuation">)</span>

<span class="token comment"># Adjusting the pipeline configuration.</span>
pipeline <span class="token operator">=</span> setup_pipeline<span class="token punctuation">(</span><span class="token string">&#x27;pipeline.config&#x27;</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>pipeline<span class="token punctuation">)</span></code></pre></div><p>Here is the content of the <code class="language-text">pipeline.config</code> file:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">model {
  ssd {
    num_classes: 1
    image_resizer {
      fixed_shape_resizer {
        height: 640
        width: 640
      }
    }
    feature_extractor {
      type: &quot;ssd_mobilenet_v2_fpn_keras&quot;
      depth_multiplier: 1.0
      min_depth: 16
      conv_hyperparams {
        regularizer {
          l2_regularizer {
            weight: 3.9999998989515007e-05
          }
        }
        initializer {
          random_normal_initializer {
            mean: 0.0
            stddev: 0.009999999776482582
          }
        }
        activation: RELU_6
        batch_norm {
          decay: 0.996999979019165
          scale: true
          epsilon: 0.0010000000474974513
        }
      }
      use_depthwise: true
      override_base_feature_extractor_hyperparams: true
      fpn {
        min_level: 3
        max_level: 7
        additional_layer_depth: 128
      }
    }
    box_coder {
      faster_rcnn_box_coder {
        y_scale: 10.0
        x_scale: 10.0
        height_scale: 5.0
        width_scale: 5.0
      }
    }
    matcher {
      argmax_matcher {
        matched_threshold: 0.5
        unmatched_threshold: 0.5
        ignore_thresholds: false
        negatives_lower_than_unmatched: true
        force_match_for_each_row: true
        use_matmul_gather: true
      }
    }
    similarity_calculator {
      iou_similarity {
      }
    }
    box_predictor {
      weight_shared_convolutional_box_predictor {
        conv_hyperparams {
          regularizer {
            l2_regularizer {
              weight: 3.9999998989515007e-05
            }
          }
          initializer {
            random_normal_initializer {
              mean: 0.0
              stddev: 0.009999999776482582
            }
          }
          activation: RELU_6
          batch_norm {
            decay: 0.996999979019165
            scale: true
            epsilon: 0.0010000000474974513
          }
        }
        depth: 128
        num_layers_before_predictor: 4
        kernel_size: 3
        class_prediction_bias_init: -4.599999904632568
        share_prediction_tower: true
        use_depthwise: true
      }
    }
    anchor_generator {
      multiscale_anchor_generator {
        min_level: 3
        max_level: 7
        anchor_scale: 4.0
        aspect_ratios: 1.0
        aspect_ratios: 2.0
        aspect_ratios: 0.5
        scales_per_octave: 2
      }
    }
    post_processing {
      batch_non_max_suppression {
        score_threshold: 9.99999993922529e-09
        iou_threshold: 0.6000000238418579
        max_detections_per_class: 100
        max_total_detections: 100
        use_static_shapes: false
      }
      score_converter: SIGMOID
    }
    normalize_loss_by_num_matches: true
    loss {
      localization_loss {
        weighted_smooth_l1 {
        }
      }
      classification_loss {
        weighted_sigmoid_focal {
          gamma: 2.0
          alpha: 0.25
        }
      }
      classification_weight: 1.0
      localization_weight: 1.0
    }
    encode_background_as_zeros: true
    normalize_loc_loss_by_codesize: true
    inplace_batchnorm_update: true
    freeze_batchnorm: false
  }
}
train_config {
  batch_size: 8
  data_augmentation_options {
    random_horizontal_flip {
    }
  }
  data_augmentation_options {
    random_crop_image {
      min_object_covered: 0.0
      min_aspect_ratio: 0.75
      max_aspect_ratio: 3.0
      min_area: 0.75
      max_area: 1.0
      overlap_thresh: 0.0
    }
  }
  sync_replicas: true
  optimizer {
    momentum_optimizer {
      learning_rate {
        cosine_decay_learning_rate {
          learning_rate_base: 0.07999999821186066
          total_steps: 50000
          warmup_learning_rate: 0.026666000485420227
          warmup_steps: 1000
        }
      }
      momentum_optimizer_value: 0.8999999761581421
    }
    use_moving_average: false
  }
  fine_tune_checkpoint: &quot;cache/datasets/ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8/checkpoint/ckpt-0&quot;
  num_steps: 50000
  startup_delay_steps: 0.0
  replicas_to_aggregate: 8
  max_number_of_boxes: 100
  unpad_groundtruth_tensors: false
  fine_tune_checkpoint_type: &quot;detection&quot;
  fine_tune_checkpoint_version: V2
}
train_input_reader {
  label_map_path: &quot;dataset/printed_links/labels/label_map.pbtxt&quot;
  tf_record_input_reader {
    input_path: &quot;dataset/printed_links/tfrecords/train.record&quot;
  }
}
eval_config {
  metrics_set: &quot;coco_detection_metrics&quot;
  use_moving_averages: false
}
eval_input_reader {
  label_map_path: &quot;dataset/printed_links/labels/label_map.pbtxt&quot;
  shuffle: false
  num_epochs: 1
  tf_record_input_reader {
    input_path: &quot;dataset/printed_links/tfrecords/test.record&quot;
  }
}</code></pre></div><h3 id="launching-the-training-process" style="position:relative">Launching the training process<a href="#launching-the-training-process" aria-label="launching the training process permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>We&#x27;re ready now to launch a training process using the TensorFlow 2 Object Detection API. The API contains a <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/model_main_tf2.py">model_main_tf2.py</a> script that will run training for us. Feel free to explore the flags that this Python script supports in the source-code (i.e. <code class="language-text">num_train_steps</code>, <code class="language-text">model_dir</code> and others) to see their meanings.</p><p>We will be training the model for <code class="language-text">1000</code> iterations (epochs). Feel free to train it for a smaller or larger number of iterations depending on the learning progress (see the TensorBoard charts).</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">%%bash

<span class="token assign-left variable">NUM_TRAIN_STEPS</span><span class="token operator">=</span><span class="token number">1000</span>
<span class="token assign-left variable">CHECKPOINT_EVERY_N</span><span class="token operator">=</span><span class="token number">1000</span>

<span class="token assign-left variable">PIPELINE_CONFIG_PATH</span><span class="token operator">=</span>pipeline.config
<span class="token assign-left variable">MODEL_DIR</span><span class="token operator">=</span>./logs
<span class="token assign-left variable">SAMPLE_1_OF_N_EVAL_EXAMPLES</span><span class="token operator">=</span><span class="token number">1</span>

python ./models/research/object_detection/model_main_tf2.py <span class="token punctuation">\</span>
  --model_dir<span class="token operator">=</span><span class="token variable">$MODEL_DIR</span> <span class="token punctuation">\</span>
  --num_train_steps<span class="token operator">=</span><span class="token variable">$NUM_TRAIN_STEPS</span> <span class="token punctuation">\</span>
  --sample_1_of_n_eval_examples<span class="token operator">=</span><span class="token variable">$SAMPLE_1_OF_N_EVAL_EXAMPLES</span> <span class="token punctuation">\</span>
  --pipeline_config_path<span class="token operator">=</span><span class="token variable">$PIPELINE_CONFIG_PATH</span> <span class="token punctuation">\</span>
  --checkpoint_every_n<span class="token operator">=</span><span class="token variable">$CHECKPOINT_EVERY_N</span> <span class="token punctuation">\</span>
  --alsologtostderr</code></pre></div><p>While the model is training (it may take around<code class="language-text">~10 minutes</code> for <code class="language-text">1000</code> iterations in <a href="https://colab.research.google.com/notebooks/gpu.ipynb">GoogleColab GPU</a> runtime) you should be able to observe the training progress in TensorBoard. The <code class="language-text">localization</code> and <code class="language-text">classification</code> losses should decrease which means that the model is doing a good job in localizing and classifying new custom objects.</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:46.800000000000004%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAgABBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEA/9oADAMBAAIQAxAAAAHtakJlR//EABcQAAMBAAAAAAAAAAAAAAAAAAABEiD/2gAIAQEAAQUClEolY//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/Aar/xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAIAQIBAT8BmI//xAAXEAADAQAAAAAAAAAAAAAAAAAAATEg/9oACAEBAAY/AoiIix//xAAZEAACAwEAAAAAAAAAAAAAAAAA8QEQQeH/2gAIAQEAAT8hjjC4TG3/AP/aAAwDAQACAAMAAAAQ4B//xAAWEQADAAAAAAAAAAAAAAAAAAAAEVH/2gAIAQMBAT8QajU//8QAFxEBAAMAAAAAAAAAAAAAAAAAABFRYf/aAAgBAgEBPxDBCn//xAAcEAACAQUBAAAAAAAAAAAAAAAAAREQITFxofH/2gAIAQEAAT8QjXm0E2VwnmRYUZ//2Q==&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Training Process" title="Training Process" src="/static/f0ee38bedbfe135b3b118411cdb68c50/a2510/23.jpg" srcSet="/static/f0ee38bedbfe135b3b118411cdb68c50/0479a/23.jpg 250w,/static/f0ee38bedbfe135b3b118411cdb68c50/41099/23.jpg 500w,/static/f0ee38bedbfe135b3b118411cdb68c50/a2510/23.jpg 1000w,/static/f0ee38bedbfe135b3b118411cdb68c50/c58a3/23.jpg 1500w,/static/f0ee38bedbfe135b3b118411cdb68c50/3acf0/23.jpg 2000w,/static/f0ee38bedbfe135b3b118411cdb68c50/8b3ab/23.jpg 2390w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>Also during the training, the new model checkpoints (parameters that the model has learned during the training) will be saved to the <code class="language-text">logs</code> folder.</p><p>The <code class="language-text">logs</code> folder structure now looks like this:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">logs
├── checkpoint
├── ckpt-1.data-00000-of-00001
├── ckpt-1.index
└── train
    └── events.out.tfevents.1606560330.b314c371fa10.1747.1628.v2</code></pre></div><h3 id="evaluating-the-model-optional" style="position:relative">Evaluating the Model (Optional)<a href="#evaluating-the-model-optional" aria-label="evaluating the model optional permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h3><p>The evaluation process uses the trained model checkpoints and evaluates how well the model performs in detecting objects in the test dataset. The results of this evaluation are summarised in the form of some <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/evaluation_protocols.md">metrics</a>, which can be examined over time. You may read more about how to evaluate these metrics <a href="https://tensorflow-object-detection-api-tutorial.readthedocs.io/en/latest/training.html#evaluating-the-model-optional">here</a>.</p><p>We will skip the metrics evaluation step in this article. But we may still use the evaluation step to see the model&#x27;s detections in TensorBoard:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">%%bash

<span class="token assign-left variable">PIPELINE_CONFIG_PATH</span><span class="token operator">=</span>pipeline.config
<span class="token assign-left variable">MODEL_DIR</span><span class="token operator">=</span>logs

python ./models/research/object_detection/model_main_tf2.py <span class="token punctuation">\</span>
  --model_dir<span class="token operator">=</span><span class="token variable">$MODEL_DIR</span> <span class="token punctuation">\</span>
  --pipeline_config_path<span class="token operator">=</span><span class="token variable">$PIPELINE_CONFIG_PATH</span> <span class="token punctuation">\</span>
  --checkpoint_dir<span class="token operator">=</span><span class="token variable">$MODEL_DIR</span> <span class="token punctuation">\</span></code></pre></div><p>After launching the script you should be able to see several side-by-side images with detections boxes:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:1000px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:42%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABYBAQEBAAAAAAAAAAAAAAAAAAEAAv/aAAwDAQACEAMQAAAB2LGWQ3//xAAWEAADAAAAAAAAAAAAAAAAAAAAAhL/2gAIAQEAAQUClSFIU//EABYRAAMAAAAAAAAAAAAAAAAAAAABEf/aAAgBAwEBPwGsrP/EABcRAAMBAAAAAAAAAAAAAAAAAAABERL/2gAIAQIBAT8ByiI//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAExMv/aAAgBAQAGPwKIyiI//8QAGBAAAgMAAAAAAAAAAAAAAAAAAAEh0fH/2gAIAQEAAT8hiBNoMo//2gAMAwEAAgADAAAAEAvP/8QAFREBAQAAAAAAAAAAAAAAAAAAAGH/2gAIAQMBAT8Qss//xAAVEQEBAAAAAAAAAAAAAAAAAAAAYf/aAAgBAgEBPxCKT//EABkQAAMAAwAAAAAAAAAAAAAAAAABESExkf/aAAgBAQABPxC7Nci3MAjoH//Z&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Model Evaluation" title="Model Evaluation" src="/static/4e770b2825aa52724dd190abec9b4384/a2510/24.jpg" srcSet="/static/4e770b2825aa52724dd190abec9b4384/0479a/24.jpg 250w,/static/4e770b2825aa52724dd190abec9b4384/41099/24.jpg 500w,/static/4e770b2825aa52724dd190abec9b4384/a2510/24.jpg 1000w,/static/4e770b2825aa52724dd190abec9b4384/c58a3/24.jpg 1500w,/static/4e770b2825aa52724dd190abec9b4384/3acf0/24.jpg 2000w,/static/4e770b2825aa52724dd190abec9b4384/56873/24.jpg 2332w" sizes="(max-width: 1000px) 100vw, 1000px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><h2 id="-exporting-the-model" style="position:relative">🗜 Exporting the Model<a href="#-exporting-the-model" aria-label=" exporting the model permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>Once the training process is complete we should save the trained model for further usage. To export the model we will use the <a href="https://github.com/tensorflow/models/blob/master/research/object_detection/exporter_main_v2.py">exporter_main_v2.py</a> script from Object Detection API. It prepares an object detection TensorFlow graph for inference using model configuration and a trained checkpoint. The script outputs associated checkpoint files, a SavedModel, and a copy of the model config:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">%%bash

python ./models/research/object_detection/exporter_main_v2.py <span class="token punctuation">\</span>
    --input_type<span class="token operator">=</span>image_tensor <span class="token punctuation">\</span>
    --pipeline_config_path<span class="token operator">=</span>pipeline.config <span class="token punctuation">\</span>
    --trained_checkpoint_dir<span class="token operator">=</span>logs <span class="token punctuation">\</span>
    --output_directory<span class="token operator">=</span>exported/ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8</code></pre></div><p>Here is what the <code class="language-text">exported</code> folder contains after the export:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">exported
└── ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8
    ├── checkpoint
    │   ├── checkpoint
    │   ├── ckpt-0.data-00000-of-00001
    │   └── ckpt-0.index
    ├── pipeline.config
    └── saved_model
        ├── assets
        ├── saved_model.pb
        └── variables
            ├── variables.data-00000-of-00001
            └── variables.index</code></pre></div><p>At this moment we have a <code class="language-text">saved_model</code> that may be used for inference.</p><h2 id="-using-the-exported-model" style="position:relative">🚀 Using the Exported Model<a href="#-using-the-exported-model" aria-label=" using the exported model permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>Let&#x27;s see how can we use the saved model from the previous step for object detections.</p><p>First, we need to create a detection function that will use the saved model. It will accept the image and will output the detected objects:</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> time
<span class="token keyword">import</span> math

PATH_TO_SAVED_MODEL <span class="token operator">=</span> <span class="token string">&#x27;exported/ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8/saved_model&#x27;</span>

<span class="token keyword">def</span> <span class="token function">detection_function_from_saved_model</span><span class="token punctuation">(</span>saved_model_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;Loading saved model...&#x27;</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">&#x27;&#x27;</span><span class="token punctuation">)</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Load saved model and build the detection function</span>
    detect_fn <span class="token operator">=</span> tf<span class="token punctuation">.</span>saved_model<span class="token punctuation">.</span>load<span class="token punctuation">(</span>saved_model_path<span class="token punctuation">)</span>

    end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    elapsed_time <span class="token operator">=</span> end_time <span class="token operator">-</span> start_time

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&#x27;Done! Took {} seconds&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>elapsed_time<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> detect_fn

exported_detect_fn <span class="token operator">=</span> detection_function_from_saved_model<span class="token punctuation">(</span>
    PATH_TO_SAVED_MODEL
<span class="token punctuation">)</span></code></pre></div><p><em>output →</em></p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Loading saved model...Done! Took 9 seconds</code></pre></div><p>To map the IDs of the detected classes back to the class names we need to load the label map as well:</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> object_detection<span class="token punctuation">.</span>utils <span class="token keyword">import</span> label_map_util

category_index <span class="token operator">=</span> label_map_util<span class="token punctuation">.</span>create_category_index_from_labelmap<span class="token punctuation">(</span>
    <span class="token string">&#x27;dataset/printed_links/labels/label_map.pbtxt&#x27;</span><span class="token punctuation">,</span>
    use_display_name<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>category_index<span class="token punctuation">)</span></code></pre></div><p><em>output →</em></p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">{1: {&#x27;id&#x27;: 1, &#x27;name&#x27;: &#x27;http&#x27;}}</code></pre></div><p>Testing the model on a test dataset.</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token keyword">from</span> object_detection<span class="token punctuation">.</span>utils <span class="token keyword">import</span> visualization_utils
<span class="token keyword">from</span> object_detection<span class="token punctuation">.</span>data_decoders<span class="token punctuation">.</span>tf_example_decoder <span class="token keyword">import</span> TfExampleDecoder

<span class="token operator">%</span>matplotlib inline

<span class="token keyword">def</span> <span class="token function">tensors_from_tfrecord</span><span class="token punctuation">(</span>
    tfrecords_filename<span class="token punctuation">,</span>
    tfrecords_num<span class="token punctuation">,</span>
    dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>float32
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    decoder <span class="token operator">=</span> TfExampleDecoder<span class="token punctuation">(</span><span class="token punctuation">)</span>
    raw_dataset <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>TFRecordDataset<span class="token punctuation">(</span>tfrecords_filename<span class="token punctuation">)</span>
    images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> raw_record <span class="token keyword">in</span> raw_dataset<span class="token punctuation">.</span>take<span class="token punctuation">(</span>tfrecords_num<span class="token punctuation">)</span><span class="token punctuation">:</span>
        example <span class="token operator">=</span> decoder<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>raw_record<span class="token punctuation">)</span>
        image <span class="token operator">=</span> example<span class="token punctuation">[</span><span class="token string">&#x27;image&#x27;</span><span class="token punctuation">]</span>
        image <span class="token operator">=</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>image<span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">)</span>
        images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>image<span class="token punctuation">)</span>

    <span class="token keyword">return</span> images

<span class="token keyword">def</span> <span class="token function">test_detection</span><span class="token punctuation">(</span>tfrecords_filename<span class="token punctuation">,</span> tfrecords_num<span class="token punctuation">,</span> detect_fn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    image_tensors <span class="token operator">=</span> tensors_from_tfrecord<span class="token punctuation">(</span>
        tfrecords_filename<span class="token punctuation">,</span>
        tfrecords_num<span class="token punctuation">,</span>
        dtype<span class="token operator">=</span>tf<span class="token punctuation">.</span>uint8
    <span class="token punctuation">)</span>

    <span class="token keyword">for</span> image_tensor <span class="token keyword">in</span> image_tensors<span class="token punctuation">:</span>
        image_np <span class="token operator">=</span> image_tensor<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># The model expects a batch of images, so add an axis with `tf.newaxis`.</span>
        input_tensor <span class="token operator">=</span> tf<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>image_tensor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

        detections <span class="token operator">=</span> detect_fn<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>

        <span class="token comment"># All outputs are batches tensors.</span>
        <span class="token comment"># Convert to numpy arrays, and take index [0] to remove the batch dimension.</span>
        <span class="token comment"># We&#x27;re only interested in the first num_detections.</span>
        num_detections <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>detections<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">&#x27;num_detections&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        detections <span class="token operator">=</span> <span class="token punctuation">{</span>key<span class="token punctuation">:</span> value<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">:</span>num_detections<span class="token punctuation">]</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> detections<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        detections<span class="token punctuation">[</span><span class="token string">&#x27;num_detections&#x27;</span><span class="token punctuation">]</span> <span class="token operator">=</span> num_detections

        <span class="token comment"># detection_classes should be ints.</span>
        detections<span class="token punctuation">[</span><span class="token string">&#x27;detection_classes&#x27;</span><span class="token punctuation">]</span> <span class="token operator">=</span> detections<span class="token punctuation">[</span><span class="token string">&#x27;detection_classes&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>int64<span class="token punctuation">)</span>

        image_np_with_detections <span class="token operator">=</span> image_np<span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

        visualization_utils<span class="token punctuation">.</span>visualize_boxes_and_labels_on_image_array<span class="token punctuation">(</span>
            image_np_with_detections<span class="token punctuation">,</span>
            detections<span class="token punctuation">[</span><span class="token string">&#x27;detection_boxes&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            detections<span class="token punctuation">[</span><span class="token string">&#x27;detection_classes&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            detections<span class="token punctuation">[</span><span class="token string">&#x27;detection_scores&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            category_index<span class="token punctuation">,</span>
            use_normalized_coordinates<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            max_boxes_to_draw<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>
            min_score_thresh<span class="token operator">=</span><span class="token number">.3</span><span class="token punctuation">,</span>
            agnostic_mode<span class="token operator">=</span><span class="token boolean">False</span>
        <span class="token punctuation">)</span>

        plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image_np_with_detections<span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>


test_detection<span class="token punctuation">(</span>
    tfrecords_filename<span class="token operator">=</span><span class="token string">&#x27;dataset/printed_links/tfrecords/test.record&#x27;</span><span class="token punctuation">,</span>
    tfrecords_num<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
    detect_fn<span class="token operator">=</span>exported_detect_fn
<span class="token punctuation">)</span></code></pre></div><p>As a result, you should see <code class="language-text">10</code> images from the test dataset and highlighted <code class="language-text">https:</code> prefixes that were detected by the model:</p><p><span class="gatsby-resp-image-wrapper" style="position:relative;display:block;margin-left:auto;margin-right:auto;max-width:976px">
      <span class="gatsby-resp-image-background-image" style="padding-bottom:98%;position:relative;bottom:0;left:0;background-image:url(&#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAECAwX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHvspJUGlQgH//EABgQAAMBAQAAAAAAAAAAAAAAAAABERAC/9oACAEBAAEFAsQ85IQkP//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABcQAAMBAAAAAAAAAAAAAAAAAAEQIHH/2gAIAQEABj8CRZ2P/8QAGxAAAwACAwAAAAAAAAAAAAAAAAEhEYFBcaH/2gAIAQEAAT8hIPexC2aYxPIx8FXHNP/aAAwDAQACAAMAAAAQIMAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHhABAAMAAgIDAAAAAAAAAAAAAQARITFxQVGRwfH/2gAIAQEAAT8QKral+xAdbr6kBcbad7liX8E25fggoFXWNHL5QWG0rX1P/9k=&#x27;);background-size:cover;display:block"></span>
  <img class="gatsby-resp-image-image" alt="Testing the model on a test dataset" title="Testing the model on a test dataset" src="/static/61aef315a3caa1f60ef57bf4df5c450f/03073/25.jpg" srcSet="/static/61aef315a3caa1f60ef57bf4df5c450f/0479a/25.jpg 250w,/static/61aef315a3caa1f60ef57bf4df5c450f/41099/25.jpg 500w,/static/61aef315a3caa1f60ef57bf4df5c450f/03073/25.jpg 976w" sizes="(max-width: 976px) 100vw, 976px" style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0" loading="lazy"/>
    </span></p><p>The fact that the model is able to detect custom objects (in our case the <code class="language-text">https://</code> prefixes) on the images it hasn&#x27;t seen before is a good sign and something that we wanted to achieve.</p><h2 id="-converting-the-model-for-web" style="position:relative">🗜 Converting the Model for Web<a href="#-converting-the-model-for-web" aria-label=" converting the model for web permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>As you remember from the beginning of this article, our goal was to use the custom object detection model in the browser. Luckily, there is a <a href="https://www.tensorflow.org/js">TensorFlow.js</a> JavaScript version of the TensorFlow library exists. In JavaScript, we can&#x27;t work with our saved model directly. Instead, we need to convert it to <a href="https://www.tensorflow.org/js/tutorials/conversion/import_saved_model">tfjs_graph_model</a> format.</p><p>To do this we need to install the tensorflowjs Python package:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">pip <span class="token function">install</span> tensorflowjs --quiet</code></pre></div><p>The model may be exported like this:</p><div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash">%%bash

tensorflowjs_converter <span class="token punctuation">\</span>
    --input_format<span class="token operator">=</span>tf_saved_model <span class="token punctuation">\</span>
    --output_format<span class="token operator">=</span>tfjs_graph_model <span class="token punctuation">\</span>
    exported/ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8/saved_model <span class="token punctuation">\</span>
    exported_web/ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8</code></pre></div><p>The <code class="language-text">exported_web</code> folder contains the <code class="language-text">.json</code> file with the model metadata and a bunch of <code class="language-text">.bin</code> files with trained model parameters:</p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">exported_web
└── ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8
    ├── group1-shard1of4.bin
    ├── group1-shard2of4.bin
    ├── group1-shard3of4.bin
    ├── group1-shard4of4.bin
    └── model.json</code></pre></div><p>Finally, we have the model that is able to detect <code class="language-text">https://</code> prefixes for us, and it is saved in JavaScript-understandable format.</p><p>Let&#x27;s check the model size to see if it is light enough to be loaded completely to the client-side:</p><div class="gatsby-highlight" data-language="python"><pre class="language-python"><code class="language-python"><span class="token keyword">import</span> pathlib

<span class="token keyword">def</span> <span class="token function">get_folder_size</span><span class="token punctuation">(</span>folder_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    mB <span class="token operator">=</span> <span class="token number">1000000</span>
    root_dir <span class="token operator">=</span> pathlib<span class="token punctuation">.</span>Path<span class="token punctuation">(</span>folder_path<span class="token punctuation">)</span>
    sizeBytes <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size <span class="token keyword">for</span> f <span class="token keyword">in</span> root_dir<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">&#x27;**/*&#x27;</span><span class="token punctuation">)</span> <span class="token keyword">if</span> f<span class="token punctuation">.</span>is_file<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f&#x27;</span><span class="token interpolation"><span class="token punctuation">{</span>sizeBytes<span class="token operator">//</span>mB<span class="token punctuation">}</span></span><span class="token string"> MB&#x27;</span></span>


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;Original model size:      </span><span class="token interpolation"><span class="token punctuation">{</span>get_folder_size<span class="token punctuation">(</span><span class="token string">&quot;cache/datasets/ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&#x27;</span></span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;Exported model size:      </span><span class="token interpolation"><span class="token punctuation">{</span>get_folder_size<span class="token punctuation">(</span><span class="token string">&quot;exported/ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&#x27;</span></span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#x27;Exported WEB model size:  </span><span class="token interpolation"><span class="token punctuation">{</span>get_folder_size<span class="token punctuation">(</span><span class="token string">&quot;exported_web/ssd_mobilenet_v2_fpnlite_640x640_coco17_tpu-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">&#x27;</span></span><span class="token punctuation">)</span></code></pre></div><p><em>output →</em></p><div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">Original model size:      31 MB
Exported model size:      28 MB
Exported WEB model size:  13 MB</code></pre></div><p>As you may see the model that we&#x27;re going to use for the Web has <code class="language-text">13MB</code> which is quite acceptable in our case.</p><p>Later in JavaScript we may start using the model like this:</p><div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> tf <span class="token keyword">from</span> <span class="token string">&#x27;@tensorflow/tfjs&#x27;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> model <span class="token operator">=</span> <span class="token keyword">await</span> tf<span class="token punctuation">.</span><span class="token function">loadGraphModel</span><span class="token punctuation">(</span>modelURL<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div><blockquote><p>🧭 The next step is to implement the Links Detector UI which will use this model, but this is another story for another article. The final source code of the application may be found in <a href="https://github.com/trekhleb/links-detector">links-detector repository</a> on GitHub.</p></blockquote><h2 id="-conclusions" style="position:relative">🤔 Conclusions<a href="#-conclusions" aria-label=" conclusions permalink" class="gatsby-remark-autolink-header-anchor after"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a></h2><p>In this article, we started to solve the issue with printed links detection. We ended up creating the custom object detector to recognize the <code class="language-text">https://</code> prefixes on text images (i.e. on smartphone camera stream images). We have also converted the model to a <code class="language-text">tfjs_graph_model</code> to be able to re-use it on the client-side.</p><p>You may 🚀 <a href="https://trekhleb.dev/links-detector/">launch Links Detector demo</a> from your smartphone to see the final result and to try how the model performs on your books or magazines.</p><p>Here is how the final solution looks like:</p><p><img src="/posts-assets/2dc300f4cc152c8b14200c25eba77a02/26.gif" alt="Links Detector Demo"/></p><p>You may also 📝 <a href="https://github.com/trekhleb/links-detector">browse the links-detector repository</a> on GitHub to see the complete source code of the UI part of the application.</p><blockquote><p>⚠️ Currently the application is in <em>experimental</em> <em>Alpha</em> stage and has <a href="https://github.com/trekhleb/links-detector/issues?q=is%3Aopen+is%3Aissue+label%3Aenhancement">many issues and limitations</a>. So don&#x27;t raise your expectations level too high until these issues are resolved 🤷🏻‍.</p></blockquote><p>As the next steps which might improve the model performance we might do the following:</p><ul><li>Extend the dataset with more link types (<code class="language-text">http://</code>, <code class="language-text">tcp://</code>, <code class="language-text">ftp://</code> etc)</li><li>Extended the dataset with images that have dark backgrounds</li><li>Extend the dataset with underlined links</li><li>Extend the dataset with examples of different fonts and ligatures</li><li>etc.</li></ul><p>Even though the model has a lot to be improved to make it closer to the production-ready state, I still hope that this article was useful for you and gave you some guidelines and inspiration to play around with your custom object detectors.</p><p>Happy training, folks!</p></article></div><div class="flex flex-row justify-center items-center mt-16"><div class="max-w-md"><div class="bg-white rounded-md shadow-md p-8"><h1 class="text-grey-darkest uppercase font-bold text-xl mb-3">Subscribe to the Newsletter</h1><p class="text-sm mb-3">Get my latest posts and project updates by email</p><form action="https://dev.us1.list-manage.com/subscribe/post?u=7714f14ff32085c685da2cfaa&amp;amp;id=53ffa81463" method="post" class="flex flex-col"><input type="text" placeholder="First Name" name="FNAME" class="border py-2 px-3 mb-3 rounded border-gray-300 border-solid appearance-none" required=""/><input type="email" placeholder="Email" name="EMAIL" class="border py-2 px-3 mb-3 rounded border-gray-300 border-solid appearance-none" required=""/><div class="hidden" aria-hidden="true"><input type="text" name="b_7714f14ff32085c685da2cfaa_53ffa81463" tabindex="-1"/></div><input type="submit" value="Subscribe" class="transition duration-200 ease-in-out bg-black text-white py-2 px-3 rounded shadow-sm cursor-pointer hover:bg-gray-800"/></form></div></div></div></article><footer class="px-6 sm:px-12 py-12"><div class="flex flex-col sm:flex-row items-center "><div style="flex:1" class="flex flex-row items-center mb-6 sm:mb-0"><a class="transition duration-200 ease-in-out flex flex-row items-center hover:text-red-600 text-xs mr-5" href="/subscribe"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0 0 68.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"></path></svg><span class="w-2"></span>Subscribe</a><a href="https://github.com/trekhleb/trekhleb.github.io/discussions" class="transition duration-200 ease-in-out flex flex-row items-center hover:text-red-600 text-xs mr-5"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg><span class="w-2"></span>Feedback</a><a class="transition duration-200 ease-in-out flex flex-row items-center hover:text-red-600 text-xs" href="/rss.xml"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg><span class="w-2"></span>RSS</a></div><div style="flex:1" class="flex flex-row items-center justify-center"><ul class="flex flex-row flex-wrap "><li class="flex flex-row items-center last:mr-0 mr-2 ml-2"><a href="https://www.linkedin.com/in/trekhleb/" class="transition duration-200 ease-in-out flex flex-row items-center hover:text-red-600 " title="Oleksii Trekhleb on LinkedIn"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></a></li><li class="flex flex-row items-center last:mr-0 mr-2 ml-2"><a href="https://github.com/trekhleb" class="transition duration-200 ease-in-out flex flex-row items-center hover:text-red-600 " title="Oleksii Trekhleb on GitHub"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 496 512" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></li><li class="flex flex-row items-center last:mr-0 mr-2 ml-2"><a href="https://twitter.com/Trekhleb" class="transition duration-200 ease-in-out flex flex-row items-center hover:text-red-600 " title="Oleksii Trekhleb on Twitter"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></li></ul></div><div style="flex:1" class="hidden sm:flex"> </div></div></footer></div></main></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-YJ73BX984Z"></script><script>
      
      
      if(true) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){window.dataLayer && window.dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-YJ73BX984Z', {"send_page_view":false});
      }
      </script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/2020/printed-links-detection/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-b7afeec9af34d175ba4b.js"],"app":["/app-ab2a30ee84bb35ad4a6a.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-63f1eb2c9d9eccd00add.js"],"component---src-pages-blog-tsx":["/component---src-pages-blog-tsx-09e5ed745cd76684f8ac.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-700f213869b8e0037911.js"],"component---src-pages-projects-tsx":["/component---src-pages-projects-tsx-4ad4f24f0965748fc53e.js"],"component---src-pages-subscribe-confirm-index-tsx":["/component---src-pages-subscribe-confirm-index-tsx-7d43f1b2228f03a924f8.js"],"component---src-pages-subscribe-index-tsx":["/component---src-pages-subscribe-index-tsx-c02ecb9201e3fc4b2ce6.js"],"component---src-pages-subscribe-thanks-index-tsx":["/component---src-pages-subscribe-thanks-index-tsx-cec855950644a6361532.js"],"component---src-templates-post-tsx":["/component---src-templates-post-tsx-c4045391b1a7c095d609.js"],"component---src-templates-project-tsx":["/component---src-templates-project-tsx-d7e84ca35145045f8249.js"]};/*]]>*/</script><script src="/polyfill-b7afeec9af34d175ba4b.js" nomodule=""></script><script src="/component---src-templates-post-tsx-c4045391b1a7c095d609.js" async=""></script><script src="/commons-92cda2548ad624e1d741.js" async=""></script><script src="/app-ab2a30ee84bb35ad4a6a.js" async=""></script><script src="/framework-d63adeb7e1b44b7b8aa5.js" async=""></script><script src="/webpack-runtime-1310037a05e01c1b407b.js" async=""></script></body></html>